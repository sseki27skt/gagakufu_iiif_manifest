<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mirador Viewer Host</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/mirador/3.6.0/mirador.min.css">
    <style>
        html, body {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            display: flex; /* 追加: コンテナを中央に配置するためにflexboxを使用 */
            align-items: center; /* 追加 */
            justify-content: center; /* 追加 */
            background-color: #f0f0f0; /* 追加: 背景色で境界を分かりやすく */
        }
        #mirador-viewer-container {
            width: 100%;
            height: 100%;
            /* min-height: 200px; /* Optional: Minimum height if it collapses */
        }
        /* ロード中のメッセージスタイル */
        .loading-message {
            font-family: sans-serif;
            font-size: 1.2em;
            color: #555;
            text-align: center;
            padding: 20px;
        }
    </style>
</head>
<body>
    <div id="mirador-viewer-container">
        <div class="loading-message">Miradorビューアーをロード中...</div>
    </div>

    <script type="text/javascript">
        let currentManifestId = null;
        let miradorInstance = null;
        let pendingManifestId = null;
        let miradorScriptLoaded = false; // Miradorスクリプトのロード状態を追跡

        // Mirador スクリプトを動的にロードし、ロード完了を保証する関数
        function loadMiradorScript() {
            return new Promise((resolve, reject) => {
                // 既にロード済みならすぐに解決
                if (miradorScriptLoaded && typeof Mirador !== 'undefined') {
                    resolve();
                    return;
                }

                // スクリプト要素を作成
                const script = document.createElement('script');
                script.src = "https://cdnjs.cloudflare.com/ajax/libs/mirador/3.6.0/mirador.min.js";
                script.async = true; // 非同期ロード

                script.onload = () => {
                    console.log("Mirador CDN script loaded successfully.");
                    miradorScriptLoaded = true;
                    if (typeof Mirador === 'undefined') {
                         console.error("Mirador object still undefined after script onload. Retrying after a short delay.");
                         // 稀にonload直後にオブジェクトが利用できない場合があるので、少し待ってから解決
                         setTimeout(() => {
                             if (typeof Mirador !== 'undefined') {
                                 resolve();
                             } else {
                                 reject(new Error("Mirador object not found after onload and retry."));
                             }
                         }, 100); // 100ms 待つ
                    } else {
                        resolve();
                    }
                };

                script.onerror = (e) => {
                    console.error("Failed to load Mirador CDN script.", e);
                    reject(new Error("Mirador CDN script failed to load."));
                };

                // スクリプトをドキュメントの<body>に挿入してロードを開始
                document.body.appendChild(script);
            });
        }

        async function initializeMirador(manifestId) {
            if (!manifestId) {
                console.warn('Manifest ID is empty. Mirador will not be initialized.');
                return;
            }

            if (manifestId === currentManifestId) {
                console.log('Manifest is already loaded:', manifestId);
                return;
            }

            console.log('Attempting to initialize Mirador with manifest:', manifestId);
            pendingManifestId = manifestId; // ロード待機中のマニフェストを保存

            try {
                // Miradorスクリプトのロードが完了するまで待つ
                await loadMiradorScript();

                // ロード完了後、Mirador オブジェクトが利用可能であることを確認
                if (typeof Mirador === 'undefined') {
                    const container = document.getElementById('mirador-viewer-container');
                    if (container) {
                        container.innerHTML = `<div class="loading-message" style="color: red;">
                                                Miradorビューアーの初期化に失敗しました。<br>
                                                必要なスクリプトが読み込めませんでした。
                                              </div>`;
                    }
                    console.error("Mirador global object is still undefined after loadMiradorScript completion. This is critical.");
                    return;
                }

                // ここから Mirador の初期化ロジック
                console.log('Mirador global object is now available. Proceeding with initialization.');
                currentManifestId = manifestId;
                pendingManifestId = null; // 初期化が始まるのでクリア

                const container = document.getElementById('mirador-viewer-container');
                if (container) {
                    container.innerHTML = ''; // 古いメッセージをクリア
                } else {
                    console.error('Mirador container not found!');
                    return;
                }

                const config = {
                    id: 'mirador-viewer-container',
                    windows: [
                        {
                            manifestId: manifestId,
                            canvasIndex: 0,
                            thumbnailNavigationPosition: 'off'
                        }
                    ],
                    workspace: {
                        type: 'single',
                        showZoomControls: true
                    },
                    views: [
                        {
                            key: 'single',
                            behaviors: ['individuals']
                        },
                        {
                            key: 'gallery',
                            behaviors: ['paged']
                        },
                        {
                            key: 'scroll',
                            behaviors: ['continuous']
                        }
                    ],
                    window: {
                        defaultView: 'scroll',
                        sideBarOpen: false,
                        allowClose: false,
                        allowMaximize: false,
                        allowTopMenuButton: false,
                        forceViewer: true,
                        viewsMenu: true
                    }
                };
                miradorInstance = Mirador.viewer(config);
                console.log('Mirador viewer initialized successfully.');

            } catch (error) {
                console.error("Error during Mirador script load or initialization:", error);
                const container = document.getElementById('mirador-viewer-container');
                if (container) {
                    container.innerHTML = `<div class="loading-message" style="color: red;">
                                            Miradorビューアーの読み込みに失敗しました。<br>
                                            詳細: ${error.message}<br>
                                            インターネット接続を確認するか、ブラウザのキャッシュをクリアしてください。
                                          </div>`;
                }
            }
        }

        // Parent page message listener
        window.addEventListener('message', function(event) {
            // Security: Restrict event.origin as appropriate for production
            // if (event.origin !== "https://your-main-app-domain.github.io") return;

            if (event.data && event.data.type === 'loadManifest') {
                const manifestId = event.data.manifestUrl;
                initializeMirador(manifestId);
            }
        });

        // Handle initial manifest from URL parameter (for direct access/debugging)
        const urlParams = new URLSearchParams(window.location.search);
        const initialManifest = urlParams.get('manifest');

        // ★★★ ページがロードされたら、まず Mirador スクリプトのロードを開始 ★★★
        document.addEventListener('DOMContentLoaded', () => {
            console.log("Mirador host page DOMContentLoaded. Starting Mirador script load.");
            // ページの初回ロード時、またはリロード時にのみ実行
            // initialManifest があればそれを待機、なければ Mirador スクリプトのロードだけ開始
            if (initialManifest) {
                initializeMirador(initialManifest); // 初期のマニフェストがあれば、ロードと初期化を試みる
            } else {
                // 初回ロード時はまだマニフェストがないので、スクリプトのロードだけ開始し、
                // 後続のpostMessageを待つ
                loadMiradorScript().catch(err => console.error("Initial Mirador script load failed:", err));
            }
        });
    </script>
</body>
</html>