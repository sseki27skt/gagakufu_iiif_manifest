<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>é›…æ¥½è­œé–²è¦§æ”¯æ´ã‚µã‚¤ãƒˆ</title>
    <meta
      name="description"
      content="IIIFã§å…¬é–‹ã•ã‚Œã¦ã„ã‚‹é›…æ¥½è­œã‚’é–²è¦§ã§ãã¾ã™"
    />

    <script src="kanji-normalization-config.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", -apple-system, BlinkMacSystemFont, "Roboto",
          "Helvetica Neue", Arial, sans-serif;
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        height: 100vh;
        display: flex;
        flex-direction: column;
      }

      .header {
        background: linear-gradient(
          135deg,
          #1e40af 0%,
          #3730a3 50%,
          #581c87 100%
        );
        color: white;
        padding: 15px 20px;
        box-shadow: 0 8px 32px rgba(30, 64, 175, 0.15);
        position: relative;
        overflow: hidden;
      }

      .header::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(
          45deg,
          rgba(255, 255, 255, 0.1) 0%,
          transparent 50%
        );
        pointer-events: none;
      }

      .header h1 {
        font-size: 24px;
        margin-bottom: 5px;
        transition: opacity 0.2s ease, transform 0.2s ease;
      }

      .header h1:hover {
        opacity: 0.8;
        transform: translateY(-1px);
      }

      .header p {
        font-size: 14px;
        opacity: 0.9;
      }

      .main-container {
        display: flex;
        flex: 1;
        min-height: 0;
      }

      .sidebar {
        width: 350px;
        background: white;
        border-right: 1px solid #e0e0e0;
        padding: 20px;
        overflow-y: auto;
        box-shadow: 2px 0 5px rgba(0, 0, 0, 0.05);
      }

      .viewer-area {
        flex: 1;
        background: white;
        position: relative;
        min-height: 0;
        height: 100%;
      }
      #viewerIframe {
        /* iframe ã®IDã¯ã“ã‚Œãªã®ã§ã€ã“ã“ã«ã‚¹ã‚¿ã‚¤ãƒ«ã‚’é©ç”¨ã™ã‚‹ */
        width: 100%;
        height: 100%;
        border: none;
      }

      .section {
        margin-bottom: 25px;
        padding: 15px;
        border: 1px solid #e8e8e8;
        border-radius: 8px;
        background: #fafafa;
      }

      .section h3 {
        color: #333;
        margin-bottom: 12px;
        font-size: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .manifest-list {
        max-height: 400px;
        overflow-y: auto;
        border: 1px solid #ddd;
        border-radius: 4px;
        background: white;
      }

      .manifest-item {
        padding: 10px 12px;
        border-bottom: 1px solid #f0f0f0;
        cursor: pointer;
        transition: background-color 0.2s;
        font-size: 13px;
        min-height: 40px;
        display: flex;
        align-items: center;
      }

      .manifest-item:hover {
        background-color: #f8f9ff;
      }

      .manifest-item.active {
        background-color: #e3f2fd;
        border-left: 3px solid #2196f3;
      }

      .manifest-item:last-child {
        border-bottom: none;
      }

      .manifest-header {
        padding: 8px 12px;
        background: #f0f0f0;
        font-weight: bold;
        font-size: 12px;
        color: #666;
        border-bottom: 1px solid #ddd;
        cursor: pointer;
        user-select: none;
        position: relative;
      }

      .manifest-header:hover {
        background: #e8e8e8;
      }

      .manifest-header::before {
        content: "â–¼";
        display: inline-block;
        margin-right: 8px;
        transition: transform 0.2s;
        font-size: 10px;
      }

      .manifest-header.collapsed::before {
        transform: rotate(-90deg);
      }

      .manifest-group-content {
        max-height: 300px;
        overflow-y: auto;
        transition: max-height 0.3s ease;
      }

      .manifest-group-content.collapsed {
        max-height: 0;
        overflow: hidden;
      }

      .custom-url {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        margin-bottom: 10px;
      }

      .btn {
        background: #2196f3;
        color: white;
        border: none;
        padding: 10px 16px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: background-color 0.2s;
      }

      .btn:hover {
        background: #1976d2;
      }

      .btn.secondary {
        background: #757575;
        margin-left: 8px;
      }

      .btn.secondary:hover {
        background: #616161;
      }

      .status {
        padding: 10px;
        border-radius: 4px;
        margin-top: 10px;
        font-size: 14px;
      }

      .status.success {
        background: #e8f5e8;
        color: #2e7d32;
        border: 1px solid #c8e6c9;
      }

      .status.error {
        background: #ffebee;
        color: #c62828;
        border: 1px solid #ffcdd2;
      }

      .status.info {
        background: #e3f2fd;
        color: #1565c0;
        border: 1px solid #bbdefb;
      }

      .current-info {
        background: white;
        border: 1px solid #2196f3;
        border-radius: 8px;
        padding: 15px;
      }

      .current-info h4 {
        color: #1976d2;
        margin-bottom: 10px;
      }

      .info-item {
        margin-bottom: 8px;
        font-size: 13px;
      }

      .info-label {
        font-weight: 600;
        color: #666;
      }

      .info-value {
        color: #333;
        word-break: break-all;
      }

      #universal-viewer {
        width: 100%;
        height: 100%;
        border: none;
      }

      /* å…¨ç”»é¢è¡¨ç¤ºã‚µãƒãƒ¼ãƒˆ */
      #universal-viewer:-webkit-full-screen {
        width: 100vw !important;
        height: 100vh !important;
      }

      #universal-viewer:-moz-full-screen {
        width: 100vw !important;
        height: 100vh !important;
      }

      #universal-viewer:fullscreen {
        width: 100vw !important;
        height: 100vh !important;
      }

      .loading {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: #666;
        font-size: 16px;
      }

      .error-display {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: #c62828;
        text-align: center;
        padding: 20px;
      }

      .error-display h3 {
        margin-bottom: 10px;
      }

      /* æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿æ©Ÿèƒ½ã®ã‚¹ã‚¿ã‚¤ãƒ« */
      .search-section {
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
      }

      .search-section h3 {
        color: #333;
        margin-bottom: 15px;
        font-size: 16px;
      }

      .search-input {
        width: 100%;
        padding: 10px 40px 10px 10px; /* å³å´ã«ãƒãƒ„ãƒœã‚¿ãƒ³ã®ã‚¹ãƒšãƒ¼ã‚¹ã‚’ç¢ºä¿ */
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
      }

      .search-input:focus {
        outline: none;
        border-color: #2196f3;
        box-shadow: 0 0 5px rgba(33, 150, 243, 0.3);
      }

      .search-container {
        position: relative;
        margin-bottom: 10px; /* marginã‚’containerã«ç§»å‹• */
      }

      .search-clear {
        position: absolute;
        right: 12px; /* å°‘ã—ä½™è£•ã‚’æŒãŸã›ã‚‹ */
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        font-size: 18px; /* å°‘ã—å¤§ããã—ã¦è¦‹ã‚„ã™ã */
        cursor: pointer;
        color: #6c757d;
        width: 20px;
        height: 20px;
        display: none; /* åˆæœŸçŠ¶æ…‹ã¯éè¡¨ç¤º */
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.2s ease;
      }

      .search-clear.visible {
        display: flex; /* è¡¨ç¤ºæ™‚ã¯flexboxã§ä¸­å¤®é…ç½® */
      }

      .search-clear:hover {
        color: #495057;
        background-color: #f8f9fa;
      }

      .search-actions {
        display: flex;
        gap: 8px;
        margin-bottom: 10px;
      }

      .btn-small {
        padding: 6px 12px;
        border: 1px solid #ddd;
        background: white;
        border-radius: 4px;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s;
      }

      .btn-small:hover {
        background: #f8f9fa;
        border-color: #2196f3;
      }

      .search-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
        padding-bottom: 8px;
        border-bottom: 1px solid #eee;
      }

      .sort-select {
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 6px 30px 6px 10px;
        font-size: 12px;
        font-weight: 500;
        color: #475569;
        cursor: pointer;
        transition: all 0.3s ease;
        min-width: 100px;
        background-image: url("data:image/svg+xml;charset=UTF-8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23475569' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><polyline points='6,9 12,15 18,9'></polyline></svg>");
        background-repeat: no-repeat;
        background-position: right 8px center;
        background-size: 12px;
      }

      .sort-select:hover {
        border-color: #3b82f6;
        background: linear-gradient(135deg, #ffffff 0%, #f0f9ff 100%);
      }

      .sort-select:focus {
        outline: none;
        border-color: #2563eb;
        box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
      }

      /* ãƒ¢ãƒ€ãƒ³ãªãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ */
      .filter-select {
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        border: 2px solid #e2e8f0;
        border-radius: 8px; /* ä¿®æ­£ */
        padding: 10px 35px 10px 15px; /* ä¿®æ­£ */
        font-size: 14px;
        font-weight: 500;
        color: #475569;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        min-width: 120px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08); /* ä¿®æ­£ */
        background-image: url("data:image/svg+xml;charset=UTF-8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23475569' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><polyline points='6,9 12,15 18,9'></polyline></svg>");
        background-repeat: no-repeat;
        background-position: right 10px center; /* ä¿®æ­£ */
        background-size: 16px;
      }

      .filter-select:hover {
        border-color: #3b82f6;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); /* ä¿®æ­£ */
        background: linear-gradient(
          135deg,
          #f0f9ff 0%,
          #ffffff 100%
        ); /* ä¿®æ­£ */
      }

      .filter-select:focus {
        outline: none;
        border-color: #2563eb;
        box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.15),
          0 2px 8px rgba(0, 0, 0, 0.1); /* ä¿®æ­£ */
      }

      .filter-select option {
        padding: 10px;
        background: white;
        color: #374151;
        font-weight: 500;
        transition: background-color 0.2s ease, color 0.2s ease; /* è¿½åŠ  */
      }

      .filter-select option:hover {
        /* è¿½åŠ  */
        background-color: #e0e6f7; /* æ˜ã‚‹ã„é’ */
        color: #1a2b4a; /* å°‘ã—æ¿ƒã„æ–‡å­—è‰² */
      }

      .filter-select option:checked {
        background: #3b82f6;
        color: white;
        font-weight: 600; /* è¿½åŠ  */
      }

      /* ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
      .filters {
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin: 20px 0;
      }

      @media (min-width: 400px) {
        .filters {
          display: grid;
          grid-template-columns: 1fr;
          gap: 12px;
        }
      }

      /* æ¥½æ›²ã‚¢ã‚¤ãƒ†ãƒ ã®ã‚¹ã‚¿ã‚¤ãƒ« */
      .piece-item {
        padding: 12px;
        border: 1px solid #e9ecef;
        border-radius: 6px;
        margin-bottom: 8px;
        cursor: pointer;
        transition: all 0.2s;
        background: white;
      }

      .piece-item:hover {
        border-color: #2196f3;
        background: #f8f9ff;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .piece-item:active {
        transform: translateY(0);
      }

      .piece-title {
        font-weight: 600;
        color: #333;
        margin-bottom: 4px;
        font-size: 14px;
      }

      .piece-meta {
        font-size: 12px;
        color: #666;
        display: flex;
        gap: 8px;
        align-items: center;
      }

      .piece-badge {
        background: #e3f2fd;
        color: #1976d2;
        padding: 2px 6px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 500;
      }

      .piece-badge.instrument {
        background: #f3e5f5;
        color: #7b1fa2;
      }

      .piece-badge.mode {
        background: #e8f5e8;
        color: #388e3c;
      }

      .piece-badge.collection {
        background: #fff3e0;
        color: #f57c00;
      }

      /* çµ±è¨ˆæƒ…å ±ã®ã‚¹ã‚¿ã‚¤ãƒ« */
      .statistics-panel {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 15px;
      }

      .statistics-panel h4 {
        margin-bottom: 15px;
        color: #333;
        font-size: 16px;
      }

      .stat-group {
        margin-bottom: 15px;
      }

      .stat-group h5 {
        margin-bottom: 8px;
        color: #555;
        font-size: 14px;
      }

      .stat-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 6px 0;
        border-bottom: 1px solid #f0f0f0;
      }

      .stat-item:last-child {
        border-bottom: none;
      }

      .stat-total {
        background: #e3f2fd;
        padding: 12px;
        border-radius: 6px;
        text-align: center;
        margin-top: 15px;
        color: #1976d2;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <div
        style="
          position: absolute;
          top: 15px;
          right: 20px;
          display: flex;
          gap: 15px;
          align-items: center;
        "
      >
        <a
          href="about.html"
          onclick="event.stopPropagation();"
          style="
            color: white;
            text-decoration: none;
            font-size: 14px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            padding: 8px 16px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            font-weight: 500;
            transition: all 0.3s ease;
          "
        >
          About
        </a>
        <a
          href="https://github.com/sseki27skt"
          target="_blank"
          style="
            color: white;
            text-decoration: none;
            font-size: 12px;
            opacity: 0.9;
            display: flex;
            align-items: center;
            gap: 4px;
          "
        >
          <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
            <path
              d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z"
            />
          </svg>
          sseki27skt
        </a>
      </div>
      <h1 style="cursor: pointer" onclick="goToHome()">
        é›…æ¥½è­œ IIIFãƒ“ãƒ¥ãƒ¼ãƒ¯ãƒ¼
      </h1>
      <p>IIIFã§å…¬é–‹ã•ã‚Œã¦ã„ã‚‹é›…æ¥½è­œã®é–²è¦§ã‚’æ”¯æ´</p>
    </div>

    <div class="main-container">
      <div class="sidebar">
        <div class="search-section">
          <h3>æ¥½æ›²æ¤œç´¢</h3>
          <div class="search-container">
            <input
              type="text"
              id="searchInput"
              class="search-input"
              placeholder="æ¥½æ›²åã‚’æ¤œç´¢..."
              onInput="searchPieces()"
            />
            <button
              class="search-clear"
              id="searchClear"
              onclick="clearSearch()"
            >
              Ã—
            </button>
          </div>

          <div class="filters">
            <select
              id="instrumentFilter"
              class="filter-select"
              onChange="searchPieces()"
            >
              <option value="">æ¥½å™¨</option>
            </select>

            <select
              id="modeFilter"
              class="filter-select"
              onChange="searchPieces()"
            >
              <option value="">èª¿å­</option>
            </select>

            <select
              id="collectionFilter"
              class="filter-select"
              onChange="searchPieces()"
            >
              <option value="">è³‡æ–™</option>
            </select>
          </div>

          <div class="search-actions">
            <button class="btn-small" onclick="clearSearchResults()">
              æ¤œç´¢çµæœã‚’ã‚¯ãƒªã‚¢
            </button>
          </div>

          <div id="searchResults" class="search-results" style="display: none">
            <div class="search-header">
              <div class="search-stats" id="searchStats"></div>
              <div class="sort-controls">
                <select
                  id="sortBy"
                  class="sort-select"
                  onChange="sortSearchResults()"
                >
                  <option value="page_range">ãƒšãƒ¼ã‚¸é †</option>
                  <option value="piece_name">æ¥½æ›²åé †</option>
                  <option value="instrument">æ¥½å™¨é †</option>
                  <option value="mode">èª¿é †</option>
                  <option value="collection">è³‡æ–™é †</option>
                </select>
              </div>
            </div>
            <div id="piecesList"></div>
          </div>
        </div>

        <div class="section">
          <h3>ğŸ“‚ ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆä¸€è¦§</h3>
          <div class="manifest-list" id="manifestList">
            <div class="loading">ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆä¸€è¦§ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
          </div>
        </div>

        <div class="section">
          <h3>ğŸ”— ã‚«ã‚¹ã‚¿ãƒ URL</h3>
          <input
            type="text"
            class="custom-url"
            id="customUrl"
            placeholder="IIIFãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã®URLã‚’å…¥åŠ›..."
          />
          <button class="btn" onclick="loadCustomManifest()">èª­ã¿è¾¼ã¿</button>
          <button class="btn secondary" onclick="refreshManifestList()">
            ä¸€è¦§æ›´æ–°
          </button>
        </div>

        <div class="section">
          <div class="current-info">
            <h4>ğŸ“Š ç¾åœ¨ã®ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆ</h4>
            <div class="info-item">
              <span class="info-label">URL:</span><br />
              <span class="info-value" id="currentUrl">æœªé¸æŠ</span>
            </div>
            <div class="info-item">
              <span class="info-label">ã‚¿ã‚¤ãƒˆãƒ«:</span><br />
              <span class="info-value" id="currentTitle">-</span>
            </div>
            <div class="info-item">
              <span class="info-label">ãƒšãƒ¼ã‚¸æ•°:</span><br />
              <span class="info-value" id="currentPages">-</span>
            </div>
          </div>
          <div id="statusDisplay"></div>
        </div>
      </div>

      <div class="viewer-area">
        <div
          style="
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 10px;
          "
        >
          <button class="btn" id="uvViewerBtn">Universal Viewerã§é–²è¦§</button>
          <button class="btn secondary" id="miradorViewerBtn">
            Miradorã§é–²è¦§ï¼ˆé€£ç¶šãƒ­ãƒ¼ãƒ«ï¼‰
          </button>
        </div>
        <iframe id="viewerIframe" src="about:blank" allow="fullscreen"></iframe>
      </div>
    </div>

    <script>
      // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
      let currentManifestUrl = null;
      let manifestCache = new Map();

      // Universal Viewer ã®è¨­å®š
      const UV_BASE_URL = "https://universalviewer.io/examples/uv/uv.html";
      const MIRADOR_BASE_URL = "https://projectmirador.org/embed/"; // Miradorã®URLã‚’è¿½åŠ 

      // GitHub Pagesã®ãƒ™ãƒ¼ã‚¹URLï¼ˆã“ã‚ŒãŒå„ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã®æ­£è¦ã®URLï¼‰
      const GITHUB_IIIF_BASE_URL =
        "https://sseki27skt.github.io/gagakufu_iiif_manifest";

      // ç¾åœ¨ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼ã®ã‚¿ã‚¤ãƒ—ã‚’è¿½è·¡
      let activeViewerType = "uv"; // åˆæœŸå€¤ã¯Universal Viewer

      // GitHub Pagesç”¨è¨­å®šï¼šMixed Contentå•é¡Œã¯ç™ºç”Ÿã—ãªã„
      function detectProtocolIssue() {
        // GitHub Pagesç‰ˆã§ã¯å¸¸ã«HTTPSãªã®ã§å•é¡Œãªã—
        return false;
      }

      // å…¨ç”»é¢è¡¨ç¤ºã‚µãƒãƒ¼ãƒˆé–¢æ•°
      function enableFullscreenSupport() {
        const iframe = document.getElementById("viewerIframe"); // IDã‚’æ±ç”¨çš„ãªã‚‚ã®ã«å¤‰æ›´

        // PostMessage APIã§iframeå†…ã‹ã‚‰ã®å…¨ç”»é¢è¦æ±‚ã‚’ç›£è¦–
        window.addEventListener("message", function (event) {
          // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãŸã‚ã€Universal Viewerã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã¿å‡¦ç†
          if (
            event.origin !== "https://universalviewer.io" &&
            event.origin !== "https://projectmirador.org"
          ) {
            // Miradorã‚‚è¿½åŠ 
            return;
          }

          // å…¨ç”»é¢è¡¨ç¤ºè¦æ±‚ã®å‡¦ç†
          if (event.data && event.data.type === "requestFullscreen") {
            requestFullscreen(iframe);
          }

          // å…¨ç”»é¢çµ‚äº†è¦æ±‚ã®å‡¦ç†
          if (event.data && event.data.type === "exitFullscreen") {
            exitFullscreen();
          }
        });

        // å…¨ç”»é¢å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆã®ç›£è¦–
        document.addEventListener("fullscreenchange", handleFullscreenChange);
        document.addEventListener(
          "webkitfullscreenchange",
          handleFullscreenChange
        );
        document.addEventListener(
          "mozfullscreenchange",
          handleFullscreenChange
        );
        document.addEventListener("MSFullscreenChange", handleFullscreenChange);
      }

      // å…¨ç”»é¢è¡¨ç¤ºã‚’è¦æ±‚
      function requestFullscreen(element) {
        if (element.requestFullscreen) {
          element.requestFullscreen();
        } else if (element.webkitRequestFullscreen) {
          element.webkitRequestFullscreen();
        } else if (element.mozRequestFullScreen) {
          element.mozRequestFullScreen();
        } else if (element.msRequestFullscreen) {
          element.msRequestFullscreen();
        }
      }

      // å…¨ç”»é¢è¡¨ç¤ºã‚’çµ‚äº†
      function exitFullscreen() {
        if (document.exitFullscreen) {
          document.exitFullscreen();
        } else if (document.webkitExitFullscreen) {
          document.webkitExitFullscreen();
        } else if (document.mozCancelFullScreen) {
          document.mozCancelFullScreen();
        } else if (document.msExitFullscreen) {
          document.msExitFullscreen();
        }
      }

      // å…¨ç”»é¢çŠ¶æ…‹å¤‰æ›´ã®å‡¦ç†
      function handleFullscreenChange() {
        const iframe = document.getElementById("viewerIframe"); // IDã‚’æ±ç”¨çš„ãªã‚‚ã®ã«å¤‰æ›´
        const isFullscreen = !!(
          document.fullscreenElement ||
          document.webkitFullscreenElement ||
          document.mozFullScreenElement ||
          document.msFullscreenElement
        );

        if (isFullscreen) {
          console.log("Entered fullscreen mode");
          // å…¨ç”»é¢ãƒ¢ãƒ¼ãƒ‰æ™‚ã®è¿½åŠ ã‚¹ã‚¿ã‚¤ãƒ«
          iframe.style.position = "fixed";
          iframe.style.top = "0";
          iframe.style.left = "0";
          iframe.style.zIndex = "9999";
        } else {
          console.log("Exited fullscreen mode");
          // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã«æˆ»ã™
          iframe.style.position = "";
          iframe.style.top = "";
          iframe.style.left = "";
          iframe.style.zIndex = "";
        }
      }

      // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
      function showStatus(message, type = "info") {
        const statusDiv = document.getElementById("statusDisplay");
        statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;

        // 5ç§’å¾Œã«è‡ªå‹•ã§æ¶ˆå»ï¼ˆã‚¨ãƒ©ãƒ¼ä»¥å¤–ï¼‰
        if (type !== "error") {
          setTimeout(() => {
            statusDiv.innerHTML = "";
          }, 5000);
        }
      }

      // ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆæƒ…å ±ã‚’æ›´æ–°
      function updateManifestInfo(url, manifest) {
        document.getElementById("currentUrl").textContent = url;

        try {
          const title =
            manifest.label ||
            manifest.metadata?.find((m) => m.label === "Title")?.value ||
            "ä¸æ˜";
          const pageCount = manifest.sequences?.[0]?.canvases?.length || 0;

          document.getElementById("currentTitle").textContent = title;
          document.getElementById(
            "currentPages"
          ).textContent = `${pageCount} ãƒšãƒ¼ã‚¸`;
        } catch (error) {
          document.getElementById("currentTitle").textContent = "ã‚¨ãƒ©ãƒ¼";
          document.getElementById("currentPages").textContent = "-";
        }
      }

      // ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã«é·ç§»ã™ã‚‹é–¢æ•°ï¼ˆãƒšãƒ¼ã‚¸ãƒªãƒ­ãƒ¼ãƒ‰æ–¹å¼ï¼‰
      function goToHome() {
        // ãƒšãƒ¼ã‚¸ã‚’å®Œå…¨ã«ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦åˆæœŸçŠ¶æ…‹ã«æˆ»ã™
        // ã“ã‚Œã«ã‚ˆã‚Šä»¥ä¸‹ãŒç¢ºå®Ÿã«ãƒªã‚»ãƒƒãƒˆã•ã‚Œã‚‹ï¼š
        // - Universal Viewerã®çŠ¶æ…‹
        // - ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã®é¸æŠçŠ¶æ…‹
        // - æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ã®çŠ¶æ…‹
        // - ãã®ä»–ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹
        window.location.reload();
      }

      // Universal Viewerã‚’èª­ã¿è¾¼ã‚€é–¢æ•°
      async function loadUniversalViewer(manifestUrlForUV) {
        const iframe = document.getElementById("viewerIframe"); // IDã‚’æ±ç”¨çš„ãªã‚‚ã®ã«å¤‰æ›´

        try {
          const uvUrl = `${UV_BASE_URL}#?manifest=${encodeURIComponent(
            manifestUrlForUV
          )}&c=0&m=0&s=0&cv=0&z=0&r=0`;

          console.log("Universal Viewer URL:", uvUrl);

          iframe.src = "about:blank";
          setTimeout(() => {
            iframe.src = uvUrl;

            let loadTimeout = setTimeout(() => {
              console.error("Universal Viewer loading timeout");
              showAlternativeViewer(manifestUrlForUV);
            }, 10000);

            iframe.onload = () => {
              clearTimeout(loadTimeout);
              console.log("Universal Viewer iframe loaded successfully");
            };

            iframe.onerror = () => {
              clearTimeout(loadTimeout);
              console.error("Universal Viewer iframe failed to load");
              showAlternativeViewer(manifestUrlForUV);
            };
          }, 500);
        } catch (error) {
          console.error("Error updating Universal Viewer:", error);
          showAlternativeViewer(manifestUrlForUV);
        }
      }

      // Miradorã‚’èª­ã¿è¾¼ã‚€é–¢æ•°
      // async function loadMiradorViewer(manifestUrlForUV) {
      //     const iframe = document.getElementById('viewerIframe'); // IDã‚’æ±ç”¨çš„ãªã‚‚ã®ã«å¤‰æ›´

      //     try {
      //         // Miradorã®embedãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§é€£ç¶šãƒ­ãƒ¼ãƒ«ï¼ˆscrollï¼‰ãƒ“ãƒ¥ãƒ¼ã‚’æŒ‡å®š
      //         const miradorUrl = `${MIRADOR_BASE_URL}?manifest=${encodeURIComponent(manifestUrlForUV)}&canvasIndex=0&view=scroll`;

      //         console.log('Mirador Viewer URL (continuous scroll):', miradorUrl);

      //         iframe.src = 'about:blank';
      //         setTimeout(() => {
      //             iframe.src = miradorUrl;

      //             let loadTimeout = setTimeout(() => {
      //                 console.error('Mirador Viewer loading timeout');
      //                 showAlternativeViewer(manifestUrlForUV);
      //             }, 10000);

      //             iframe.onload = () => {
      //                 clearTimeout(loadTimeout);
      //                 console.log('Mirador Viewer iframe loaded successfully');
      //             };

      //             iframe.onerror = () => {
      //                 clearTimeout(loadTimeout);
      //                 console.error('Mirador Viewer iframe failed to load');
      //                 showAlternativeViewer(manifestUrlForUV);
      //             };

      //         }, 500);

      //     } catch (error) {
      //         console.error('Error updating Mirador Viewer:', error);
      //         showAlternativeViewer(manifestUrlForUV);
      //     }
      // }
      // GitHub Pages ã®ãƒªãƒã‚¸ãƒˆãƒªåã¨Miradorãƒ›ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ã‚’è¨­å®š
      // ä¾‹: https://your-username.github.io/your-repo-name/mirador_viewer/index.html
      // ç¾åœ¨ã®gagakufu_iiif_manifestãƒªãƒã‚¸ãƒˆãƒªã§ãƒ›ã‚¹ãƒˆã™ã‚‹å ´åˆ
      const GITHUB_PAGES_MIRADOR_HOST_URL =
        "https://sseki27skt.github.io/gagakufu_iiif_manifest/mirador_viewer/index.html";

      // ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ã«å¯¾å¿œ
      let miradorHostUrl = GITHUB_PAGES_MIRADOR_HOST_URL;
      const isLocal =
        window.location.hostname === "localhost" ||
        window.location.hostname === "127.0.0.1";
      const localBaseUrl = `${window.location.protocol}//${window.location.host}`;

      if (isLocal) {
        // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‘ã‚¹ã«åˆã‚ã›ã¦èª¿æ•´
        // ä¾‹ãˆã°ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã«mirador_viewerãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒã‚ã‚‹å ´åˆ
        miradorHostUrl = `${localBaseUrl}/mirador_viewer/index.html`;
      }

      async function loadMiradorViewer(manifestUrl) {
        // å¼•æ•°åã‚’manifestUrlã«å¤‰æ›´
        const iframe = document.getElementById("viewerIframe");

        try {
          // ç¾åœ¨ã®iframeã®srcãŒMiradorãƒ›ã‚¹ãƒˆãƒšãƒ¼ã‚¸ã¨ç•°ãªã‚‹å ´åˆã®ã¿å†ãƒ­ãƒ¼ãƒ‰
          if (!iframe.src.startsWith(miradorHostUrl)) {
            iframe.src = "about:blank"; // å¤ã„ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ã‚¯ãƒªã‚¢
            // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’è¨­ã‘ã¦iframeã®ãƒ­ãƒ¼ãƒ‰ã‚’å¾…ã¤
            await new Promise((resolve) => {
              iframe.onload = () => {
                console.log("Mirador host iframe loaded.");
                iframe.onload = null; // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å‰Šé™¤
                resolve();
              };
              iframe.src = miradorHostUrl;
            });
          }

          // iframe ãŒãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸã‚‰ã€postMessage ã§ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆURLã‚’é€ä¿¡
          console.log("Sending manifest to Mirador iframe:", manifestUrl);
          iframe.contentWindow.postMessage(
            {
              type: "loadManifest",
              manifestUrl: manifestUrl, // ã“ã“ã§ã‚ªãƒªã‚¸ãƒŠãƒ«ï¼ˆHTTPSï¼‰ã®URLã‚’æ¸¡ã™
            },
            "*"
          ); // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãŸã‚ã€'*' ã§ã¯ãªã iframe ã®ã‚ªãƒªã‚¸ãƒ³ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã‚’æ¤œè¨

          showStatus("Miradorãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼ã‚’èª­ã¿è¾¼ã¿ä¸­...", "info");

          // Miradorãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼è‡ªä½“ãŒãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸã‹ã©ã†ã‹ã®ç›£è¦–ã¯é›£ã—ã„ã®ã§ã€
          // å¤–éƒ¨ãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼ã¸ã®ãƒªãƒ³ã‚¯ã‚’è¡¨ç¤ºã™ã‚‹ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã¯å‰Šé™¤ã¾ãŸã¯èª¿æ•´
          // setTimeout(() => { ... }, 10000); ã¯ä¸è¦ã«ãªã‚‹ã‹ã€åˆ¥ã®ç›®çš„ã§ä½¿ã†
          showStatus("Miradorãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼ãŒæ­£å¸¸ã«è¡¨ç¤ºã•ã‚Œã¾ã—ãŸ", "success");
        } catch (error) {
          console.error("Error loading Mirador Viewer:", error);
          showStatus(
            `Miradorãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`,
            "error"
          );
          // å¿…è¦ã§ã‚ã‚Œã°ã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼ã‚’è¡¨ç¤º
          showErrorInViewer(
            "Miradorãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
          );
        }
      }

      // ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‚’èª­ã¿è¾¼ã‚“ã§ãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼ã§è¡¨ç¤º
      async function loadManifest(originalManifestUrl) {
        // ã“ã“ã§å—ã‘å–ã‚‹ã®ã¯å¸¸ã«ã‚ªãƒªã‚¸ãƒŠãƒ«ã®HTTPS URL
        try {
          showStatus("ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿ä¸­...", "info");
          console.log("Loading manifest (original URL):", originalManifestUrl);

          let fetchUrl = originalManifestUrl; // ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒfetchã™ã‚‹ãŸã‚ã®URL
          const isLocal =
            window.location.hostname === "localhost" ||
            window.location.hostname === "127.0.0.1";
          const localBaseUrl = `${window.location.protocol}//${window.location.host}`;

          // ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§å®Ÿè¡Œã—ã¦ã„ã‚‹å ´åˆã€fetchUrlã‚’ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‘ã‚¹ã«å¤‰æ›
          if (isLocal && originalManifestUrl.startsWith(GITHUB_IIIF_BASE_URL)) {
            fetchUrl = originalManifestUrl.replace(
              GITHUB_IIIF_BASE_URL,
              localBaseUrl
            );
            console.log("Converted for local fetching:", fetchUrl);
          }

          // ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‚’ãƒ•ã‚§ãƒƒãƒï¼ˆè©³ç´°ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ä»˜ãï¼‰
          const response = await fetch(fetchUrl, {
            method: "GET",
            headers: {
              Accept: "application/json",
            },
            cache: "no-cache",
          }).catch((fetchError) => {
            console.error("Fetch error details:", fetchError);
            if (fetchError.message.includes("ERR_BLOCKED_BY_CLIENT")) {
              throw new Error(
                "ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚åºƒå‘Šãƒ–ãƒ­ãƒƒã‚«ãƒ¼ã‚„ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ‹¡å¼µæ©Ÿèƒ½ã‚’ç„¡åŠ¹ã«ã—ã¦ãã ã•ã„ã€‚"
              );
            }
            throw new Error(`ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼: ${fetchError.message}`);
          });

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const manifest = await response.json();
          manifestCache.set(originalManifestUrl, manifest); // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ã¯ã‚ªãƒªã‚¸ãƒŠãƒ«URLã§ä¿å­˜

          // æƒ…å ±ã‚’æ›´æ–°ï¼ˆè¡¨ç¤ºã«ã¯ã‚ªãƒªã‚¸ãƒŠãƒ«URLã‚’ä½¿ç”¨ï¼‰
          updateManifestInfo(originalManifestUrl, manifest);
          currentManifestUrl = originalManifestUrl; // ç¾åœ¨ã®ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆURLã‚’ä¿å­˜

          // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’æ›´æ–°ï¼ˆã‚ªãƒªã‚¸ãƒŠãƒ«URLã‚’ä½¿ç”¨ï¼‰
          updateActiveManifest(originalManifestUrl);

          // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼ã§ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‚’ãƒ­ãƒ¼ãƒ‰
          if (activeViewerType === "uv") {
            await loadUniversalViewer(originalManifestUrl);
          } else if (activeViewerType === "mirador") {
            await loadMiradorViewer(originalManifestUrl);
          }
          showStatus("ãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼ã®æ›´æ–°ãŒå®Œäº†ã—ã¾ã—ãŸ", "success");
        } catch (error) {
          console.error("Manifest loading error:", error);
          showStatus(`ã‚¨ãƒ©ãƒ¼: ${error.message}`, "error");

          // ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã‚’ãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼ã‚¨ãƒªã‚¢ã«
          showErrorInViewer(error.message);
        }
      }

      // ä»£æ›¿ãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼ã‚’è¡¨ç¤º
      function showAlternativeViewer(manifestUrl) {
        console.log("Showing alternative viewer for:", manifestUrl);
        showStatus(
          "Universal ViewerãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚ä»£æ›¿è¡¨ç¤ºã‚’ä½¿ç”¨ã—ã¾ã™",
          "error"
        );

        const iframe = document.getElementById("viewerIframe"); // IDã‚’æ±ç”¨çš„ãªã‚‚ã®ã«å¤‰æ›´
        iframe.src =
          "data:text/html;charset=utf-8," +
          encodeURIComponent(`
                <!DOCTYPE html>
                <html lang="ja">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>ä»£æ›¿ãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼</title>
                    <style>
                        body { 
                            font-family: Arial, sans-serif; 
                            margin: 0; 
                            padding: 20px; 
                            background: #f5f5f5;
                        }
                        .container {
                            max-width: 800px;
                            margin: 0 auto;
                            background: white;
                            padding: 20px;
                            border-radius: 8px;
                            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                        }
                        .manifest-link {
                            background: #2196f3;
                            color: white;
                            padding: 10px 20px;
                            text-decoration: none;
                            border-radius: 4px;
                            display: inline-block;
                            margin: 10px 0;
                        }
                        .manifest-link:hover {
                            background: #1976d2;
                        }
                        .troubleshoot {
                            background: #fff3cd;
                            padding: 15px;
                            border-radius: 6px;
                            border-left: 4px solid #ffc107;
                            margin-top: 20px;
                        }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <h3>ğŸ”§ ä»£æ›¿ãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼</h3>
                        <p>Universal ViewerãŒåˆ©ç”¨ã§ããªã„ãŸã‚ã€ä»£æ›¿æ‰‹æ®µã‚’æä¾›ã—ã¾ã™ï¼š</p>
                        
                        <h4>ğŸ“„ ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ï¼š</h4>
                        <a href="${manifestUrl}" target="_blank" class="manifest-link">
                            ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‚’JSONã§è¡¨ç¤º
                        </a>
                        
                        <h4>ğŸŒ å¤–éƒ¨ãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼ã§é–‹ãï¼š</h4>
                        <a href="https://universalviewer.io/uv.html?manifest=${encodeURIComponent(
                          manifestUrl
                        )}" 
                           target="_blank" class="manifest-link">
                            Universal Viewer (å¤–éƒ¨)ã§é–‹ã
                        </a>
                        
                        <a href="https://projectmirador.org/embed/?manifest=${encodeURIComponent(
                          manifestUrl
                        )}" 
                           target="_blank" class="manifest-link">
                            Mirador Viewerã§é–‹ã
                        </a>
                        
                        <div class="troubleshoot">
                            <h4>ğŸ’¡ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ï¼š</h4>
                            <ul>
                                <li>åºƒå‘Šãƒ–ãƒ­ãƒƒã‚«ãƒ¼ã‚’ç„¡åŠ¹ã«ã™ã‚‹</li>
                                <li>ãƒ–ãƒ©ã‚¦ã‚¶ã®æ‹¡å¼µæ©Ÿèƒ½ã‚’ç¢ºèªã™ã‚‹</li>
                                <li>åˆ¥ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§è©¦ã™</li>
                                <li>HTTPSã®ä»£ã‚ã‚Šã«HTTPã§ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹</li>
                            </ul>
                        </div>
                    </div>
                </body>
                </html>
            `);
      }

      // ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆä¸€è¦§ã§ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’æ›´æ–°
      function updateActiveManifest(url) {
        const items = document.querySelectorAll(".manifest-item");
        items.forEach((item) => {
          item.classList.remove("active");
          if (item.dataset.url === url) {
            // dataset.url ã¯ã‚ªãƒªã‚¸ãƒŠãƒ«URLãªã®ã§å•é¡Œãªã—
            item.classList.add("active");
          }
        });
      }

      // ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‹ã‚‰ã‚¿ã‚¤ãƒˆãƒ«æƒ…å ±ã‚’å–å¾—ã™ã‚‹é–¢æ•°ï¼ˆé›…æ¥½è­œå°‚ç”¨æ”¹è‰¯ç‰ˆï¼‰
      async function getManifestTitle(originalManifestUrl) {
        // ã‚ªãƒªã‚¸ãƒŠãƒ«URLã‚’å—ã‘å–ã‚‹
        try {
          let fetchUrl = originalManifestUrl;
          const isLocal =
            window.location.hostname === "localhost" ||
            window.location.hostname === "127.0.0.1";
          const localBaseUrl = `${window.location.protocol}//${window.location.host}`;

          // ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§å®Ÿè¡Œã—ã¦ã„ã‚‹å ´åˆã€fetchUrlã‚’ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‘ã‚¹ã«å¤‰æ›
          if (isLocal && originalManifestUrl.startsWith(GITHUB_IIIF_BASE_URL)) {
            fetchUrl = originalManifestUrl.replace(
              GITHUB_IIIF_BASE_URL,
              localBaseUrl
            );
          }

          const response = await fetch(fetchUrl, {
            cache: "no-cache",
            headers: {
              "Cache-Control": "no-cache",
              Pragma: "no-cache",
            },
          });
          if (!response.ok) return null;

          const manifest = await response.json();

          // ã‚¿ã‚¤ãƒˆãƒ«ã‚’æ§˜ã€…ãªæ–¹æ³•ã§å–å¾—ã‚’è©¦è¡Œ
          let title = null;

          // 1. label ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‹ã‚‰å–å¾—
          if (manifest.label) {
            if (typeof manifest.label === "string") {
              title = manifest.label;
            } else if (manifest.label["@value"]) {
              title = manifest.label["@value"];
            } else if (manifest.label.ja) {
              title = Array.isArray(manifest.label.ja)
                ? manifest.label.ja[0]
                : manifest.label.ja;
            } else if (manifest.label.en) {
              title = Array.isArray(manifest.label.en)
                ? manifest.label.en[0]
                : manifest.label.en;
            } else if (Array.isArray(manifest.label)) {
              title = manifest.label[0];
            }
          }

          // 2. metadata ã‹ã‚‰ã€ŒTitleã€ã¾ãŸã¯ã€Œã‚¿ã‚¤ãƒˆãƒ«ã€ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å–å¾—
          if (!title && manifest.metadata) {
            for (const meta of manifest.metadata) {
              const label = meta.label;
              if (
                label &&
                (label.includes("Title") ||
                  label.includes("ã‚¿ã‚¤ãƒˆãƒ«") ||
                  label.includes("title"))
              ) {
                if (typeof meta.value === "string") {
                  title = meta.value;
                } else if (meta.value && meta.value["@value"]) {
                  title = meta.value["@value"];
                }
                break;
              }
            }
          }

          // 3. metadata ã‹ã‚‰é›…æ¥½è­œç‰¹æœ‰ã®æƒ…å ±ã‚’å–å¾—
          if (!title && manifest.metadata) {
            // ã€Œæ’°å®šå¹´ã€ã‚„ã€Œéƒ¨ã€ã€Œèª¿ã€ãªã©ã®æƒ…å ±ã‹ã‚‰æ¨æ¸¬
            let æ’°å®šå¹´ = "";
            let éƒ¨ = "";
            let èª¿ = "";

            for (const meta of manifest.metadata) {
              const label = meta.label;
              const value =
                typeof meta.value === "string"
                  ? meta.value
                  : meta.value?.["@value"] || "";

              if (label && label.includes("æ’°å®šå¹´")) {
                æ’°å®šå¹´ = value;
              } else if (label && label.includes("éƒ¨")) {
                éƒ¨ = value;
              } else if (label && label.includes("èª¿")) {
                èª¿ = value;
              }
            }

            // æƒ…å ±ã‚’çµ„ã¿åˆã‚ã›ã¦ã‚¿ã‚¤ãƒˆãƒ«ã‚’ç”Ÿæˆ
            if (æ’°å®šå¹´ || éƒ¨ || èª¿) {
              const parts = [];
              if (æ’°å®šå¹´) parts.push(æ’°å®šå¹´);
              if (èª¿) parts.push(èª¿);
              if (éƒ¨) parts.push(éƒ¨);
              title = parts.join(" ");
            }
          }

          // 4. sequences[0].label ã‹ã‚‰å–å¾—
          if (
            !title &&
            manifest.sequences &&
            manifest.sequences[0] &&
            manifest.sequences[0].label
          ) {
            title = manifest.sequences[0].label;
          }

          // 5. description ã‹ã‚‰å–å¾—
          if (!title && manifest.description) {
            title = Array.isArray(manifest.description)
              ? manifest.description[0]
              : manifest.description;
          }

          // ã‚¿ã‚¤ãƒˆãƒ«ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
          if (title) {
            title = title.replace(/^\s+|\s+$/g, ""); // å‰å¾Œã®ç©ºç™½ã‚’å‰Šé™¤
            title = title.replace(/\s+/g, " "); // é€£ç¶šã™ã‚‹ç©ºç™½ã‚’å˜ä¸€ã‚¹ãƒšãƒ¼ã‚¹ã«

            // é›…æ¥½è­œé–¢é€£ã®ä¸è¦ãªæ–‡å­—åˆ—ã‚’é™¤å»
            title = title.replace(/^é›…æ¥½è­œ[\s\(ï¼ˆ]*/g, ""); // å…ˆé ­ã®ã€Œé›…æ¥½è­œã€ã¨ç¶šãç©ºç™½ãƒ»æ‹¬å¼§ã‚’é™¤å»
            title = title.replace(/^é›…æ¨‚è­œ[\s\(ï¼ˆ]*/g, ""); // å…ˆé ­ã®ã€Œé›…æ¨‚è­œã€ï¼ˆæ—§å­—ä½“ï¼‰ã¨ç¶šãç©ºç™½ãƒ»æ‹¬å¼§ã‚’é™¤å»
            title = title.replace(/[\)ï¼‰]*$/g, ""); // æœ«å°¾ã®æ‹¬å¼§ã‚’é™¤å»
            title = title.replace(/^[\(ï¼ˆ\s]+/g, ""); // å…ˆé ­ã®æ®‹ã£ãŸæ‹¬å¼§ã‚„ç©ºç™½ã‚’é™¤å»
            title = title.replace(/[\s]+$/g, ""); // æœ«å°¾ã®ç©ºç™½ã‚’å†åº¦é™¤å»

            // é•·ã™ãã‚‹ã‚¿ã‚¤ãƒˆãƒ«ã‚’çŸ­ç¸®
            if (title.length > 30) {
              title = title.substring(0, 27) + "...";
            }
          }

          return title;
        } catch (error) {
          console.error(
            "Failed to fetch manifest title:",
            originalManifestUrl,
            error
          );
          return null;
        }
      }

      // ãƒ­ãƒ¼ã‚«ãƒ«ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
      async function loadManifestList() {
        try {
          // console.log('Starting to load manifest list...'); // å‰Šé™¤

          if (detectProtocolIssue()) {
            loadFallbackManifestList();
            return;
          }

          showStatus("ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆä¸€è¦§ã‚’èª­ã¿è¾¼ã¿ä¸­...", "info");

          const listContainer = document.getElementById("manifestList");
          listContainer.innerHTML =
            '<div class="loading">ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆä¸€è¦§ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>';

          const isLocal =
            window.location.hostname === "localhost" ||
            window.location.hostname === "127.0.0.1";
          const localBaseUrl = `${window.location.protocol}//${window.location.host}`;

          const groups = {
            100376839: [],
            100270332: [],
          };

          // å„ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®manifest-index.jsonã‚’èª­ã¿è¾¼ã‚€ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
          const loadCollectionIndex = async (seriesId, groupArray) => {
            let indexFetchUrl = `${GITHUB_IIIF_BASE_URL}/${seriesId}/manifest-index.json`;
            // ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ã‚ã‚Œã°ã€fetchUrlã‚’ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‘ã‚¹ã«å¤‰æ›
            if (isLocal) {
              indexFetchUrl = indexFetchUrl.replace(
                GITHUB_IIIF_BASE_URL,
                localBaseUrl
              );
            }

            try {
              const response = await fetch(indexFetchUrl, {
                cache: "no-cache",
              });
              if (!response.ok) throw new Error(`HTTP ${response.status}`);
              const indexData = await response.json();
              // console.log(`Loaded ${seriesId} manifest index:`, indexData); // å‰Šé™¤
              indexData.manifests.forEach((manifest) => {
                // ã“ã“ã§ã¯å¸¸ã«ã‚ªãƒªã‚¸ãƒŠãƒ«ã®HTTPS URLã‚’æ ¼ç´
                groupArray.push({
                  url: manifest["@id"], // ã“ã‚Œã¯å¸¸ã«GitHub Pagesã®HTTPS URL
                  label: manifest.label,
                  series: seriesId,
                });
              });
            } catch (error) {
              console.error(`Error loading ${seriesId} manifest index:`, error);
              const errorDiv = document.createElement("div");
              errorDiv.style.cssText =
                "padding: 10px; color: red; text-align: center;";
              errorDiv.textContent = `${seriesId} ã®ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆä¸€è¦§ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`;
              listContainer.appendChild(errorDiv);
            }
          };

          // ä¸¦è¡Œã—ã¦ä¸¡æ–¹ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ãƒ­ãƒ¼ãƒ‰
          await Promise.all([
            loadCollectionIndex("100270332", groups["100270332"]),
            loadCollectionIndex("100376839", groups["100376839"]),
          ]);

          listContainer.innerHTML = ""; // Clear loading message

          for (const [series, files] of Object.entries(groups)) {
            if (files.length === 0) continue;

            // console.log(`Processing series: ${series} with ${files.length} files`); // å‰Šé™¤

            const groupTitle = {
              100376839: "ğŸ“œ æ±äº¬èŠ¸è¡“å¤§å­¦æ‰€è”µç‰ˆ",
              100270332: "ğŸµ å®®å†…åºæ›¸é™µéƒ¨æ‰€è”µç‰ˆ",
            }[series];

            const groupContainer = document.createElement("div");
            const header = document.createElement("div");
            header.className = "manifest-header";
            header.textContent = groupTitle;
            const contentContainer = document.createElement("div");
            contentContainer.className = "manifest-group-content";

            const isDefaultOpen = series === "100270332";
            if (!isDefaultOpen) {
              header.classList.add("collapsed");
              contentContainer.classList.add("collapsed");
            }
            header.onclick = () => {
              const isCollapsed = header.classList.contains("collapsed");
              if (isCollapsed) {
                header.classList.remove("collapsed");
                contentContainer.classList.remove("collapsed");
              } else {
                header.classList.add("collapsed");
                contentContainer.classList.remove("collapsed");
              }
            };

            let volumeCounter = 0; // å„ã‚·ãƒªãƒ¼ã‚ºã”ã¨ã«å·»ç•ªå·ã‚’ãƒªã‚»ãƒƒãƒˆ

            files.forEach((file) => {
              const item = document.createElement("div");
              item.className = "manifest-item";
              item.dataset.url = file.url; // ã“ã“ã«ã‚ªãƒªã‚¸ãƒŠãƒ«URLãŒå…¥ã‚‹
              item.onclick = () => loadManifest(file.url); // loadManifestã«ã¯ã‚ªãƒªã‚¸ãƒŠãƒ«URLã‚’æ¸¡ã™

              let displayTitle =
                file.label ||
                file.url
                  .split("/")
                  .pop()
                  .replace("_manifest.json", "")
                  .replace("volume", "Vol. ");
              // getManifestTitle é–¢æ•°ã§è¡Œã‚ã‚Œã‚‹ã‚¿ã‚¤ãƒˆãƒ«ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚’é©ç”¨
              if (displayTitle) {
                displayTitle = displayTitle.replace(/^\s+|\s+$/g, "");
                displayTitle = displayTitle.replace(/\s+/g, " ");
                displayTitle = displayTitle.replace(/^é›…æ¥½è­œ[\s\(ï¼ˆ]*/g, "");
                displayTitle = displayTitle.replace(/^é›…æ¨‚è­œ[\s\(ï¼ˆ]*/g, "");
                displayTitle = displayTitle.replace(/[\)ï¼‰]*$/g, "");
                displayTitle = displayTitle.replace(/^[\(ï¼ˆ\s]+/g, "");
                displayTitle = displayTitle.replace(/[\s]+$/g, "");
                if (displayTitle.length > 30) {
                  displayTitle = displayTitle.substring(0, 27) + "...";
                }
              }

              const volumeNumberDisplay = `Vol.${String(volumeCounter).padStart(
                2,
                "0"
              )}`; // Vol.00, Vol.01å½¢å¼
              volumeCounter++; // æ¬¡ã®é …ç›®ã®ãŸã‚ã«ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆ

              item.innerHTML = `
                            <div style="line-height: 1.3;">
                                <div style="color: #666; font-size: 10px; margin-bottom: 2px;">${volumeNumberDisplay}</div>
                                <div style="font-weight: 500; color: #333;">${displayTitle}</div>
                            </div>
                        `;
              contentContainer.appendChild(item);
            });

            groupContainer.appendChild(header);
            groupContainer.appendChild(contentContainer);
            listContainer.appendChild(groupContainer);
          }

          showStatus("ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆä¸€è¦§ã®èª­ã¿è¾¼ã¿ãŒå®Œäº†ã—ã¾ã—ãŸ", "success");
        } catch (error) {
          console.error("Error loading manifest list:", error);
          showStatus(`ä¸€è¦§èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${error.message}`, "error");

          const listContainer = document.getElementById("manifestList");
          listContainer.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #c62828;">
                        <h3>èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</h3>
                        <p>${error.message}</p>
                        <p style="font-size: 12px; margin-top: 10px;">
                            ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ã‚¨ãƒ©ãƒ¼è©³ç´°ã‚’ç¢ºèªã—ã¦ãã ã•ã„
                        </p>
                    </div>
                `;
        }
      }

      // ã‚¿ã‚¤ãƒˆãƒ«ã‚’æ®µéšçš„ã«èª­ã¿è¾¼ã‚€é–¢æ•°
      // ã“ã®é–¢æ•°ã¯ã‚‚ã†manifest-index.jsonã‹ã‚‰ã‚¿ã‚¤ãƒˆãƒ«ã‚’å–å¾—ã™ã‚‹ãŸã‚ä½¿ç”¨ã—ã¾ã›ã‚“ãŒã€
      // æ—¢å­˜ã®getManifestTitleé–¢æ•°ãŒä»–ã®å ´æ‰€ï¼ˆæ¥½æ›²æ¤œç´¢ãªã©ï¼‰ã§ä½¿ã‚ã‚Œã‚‹å¯èƒ½æ€§ã‚’è€ƒæ…®ã—ã€æ®‹ã—ã¾ã™ã€‚
      async function loadTitlesInBatches(tasks, batchSize = 5) {
        // console.log(`Loading titles in batches for ${tasks.length} items`); // å‰Šé™¤

        for (let i = 0; i < tasks.length; i += batchSize) {
          const batch = tasks.slice(i, i + batchSize);

          const promises = batch.map(
            (task) =>
              // ã“ã“ã§getManifestTitleã‚’å‘¼ã³å‡ºã™å¿…è¦ã¯ãªããªã‚Šã¾ã—ãŸãŒã€æ§‹é€ ä¸Šæ®‹ã—ã¾ã™
              // task.item, task.url, task.volume ã¯ä½¿ã‚ã‚Œã¾ã›ã‚“
              Promise.resolve() // ä½•ã‚‚ã›ãšè§£æ±º
          );

          try {
            await Promise.allSettled(promises);
            // console.log(`Completed batch ${Math.floor(i / batchSize) + 1}/${Math.ceil(tasks.length / batchSize)}`); // å‰Šé™¤

            if (i + batchSize < tasks.length) {
              await new Promise((resolve) => setTimeout(resolve, 200));
            }
          } catch (error) {
            console.error("Error in batch processing:", error);
          }
        }

        // console.log('All title loading completed'); // å‰Šé™¤
      }

      // ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’å–å¾—ã—ã¦è¡¨ç¤ºã‚’æ›´æ–°
      // loadManifestListã‹ã‚‰ã¯ç›´æ¥å‘¼ã°ã‚Œãªããªã‚Šã¾ã—ãŸãŒã€æ—¢å­˜ã®getManifestTitleãŒä½¿ã‚ã‚Œã‚‹ãŸã‚æ®‹ã—ã¾ã™ã€‚
      async function loadAndUpdateManifestTitle(
        itemElement,
        manifestUrl,
        volume
      ) {
        // ã“ã®é–¢æ•°ã¯manifest-index.jsonã‹ã‚‰ç›´æ¥ã‚¿ã‚¤ãƒˆãƒ«ãŒå–å¾—ã•ã‚Œã‚‹ã‚ˆã†ã«ãªã£ãŸãŸã‚ã€
        // loadManifestListã‹ã‚‰ã¯ç›´æ¥å‘¼ã°ã‚Œã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
        // ã—ã‹ã—ã€ä»–ã®å ´æ‰€ã‹ã‚‰å‘¼ã°ã‚Œã‚‹å¯èƒ½æ€§ã‚„ã‚³ãƒ¼ãƒ‰ã®ä¸€è²«æ€§ã‚’ä¿ã¤ãŸã‚ã«æ®‹ã—ã¾ã™ã€‚
        console.warn(
          "loadAndUpdateManifestTitle was called, but should not be directly used for manifest list population anymore."
        ); // è­¦å‘Šã¯æ®‹ã™
        try {
          const title = await getManifestTitle(manifestUrl);
          if (title) {
            itemElement.innerHTML = `
                        <div style="line-height: 1.3;">
                            <div style="color: #666; font-size: 10px; margin-bottom: 2px;">Vol.${String(
                              volume
                            ).padStart(2, "0")}</div>
                            <div style="font-weight: 500; font-size: 12px; color: #333;">${title}</div>
                        </div>
                    `;
          } else {
            itemElement.innerHTML = `
                        <div style="font-weight: 500; color: #666;">
                            Volume ${String(volume).padStart(2, "0")}
                            <div style="font-size: 10px; color: #999;">(ã‚¿ã‚¤ãƒˆãƒ«å–å¾—å¤±æ•—)</div>
                        </div>
                    `;
          }
        } catch (error) {
          console.error(`Failed to load title for ${manifestUrl}:`, error);
          itemElement.innerHTML = `
                    <div style="font-weight: 500; color: #666;">
                        Volume ${String(volume).padStart(2, "0")}
                        <div style="font-size: 10px; color: #999;">(ã‚¿ã‚¤ãƒˆãƒ«å–å¾—å¤±æ•—)</div>
                    </div>
                `;
        }
      }

      // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šãƒ˜ãƒ«ãƒ—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã¿è¡¨ç¤º
      function loadFallbackManifestList() {
        // console.log('Loading fallback manifest list (help only)'); // å‰Šé™¤
        showStatus("ãƒ­ãƒ¼ã‚«ãƒ«ã‚µãƒ¼ãƒãƒ¼ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ã€‚", "error");

        const listContainer = document.getElementById("manifestList");
        listContainer.innerHTML = "";

        // GitHub Pages ã§ã®åˆ©ç”¨ã‚’ä¿ƒã™ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
        const helpDiv = document.createElement("div");
        helpDiv.style.cssText = `
                background: linear-gradient(135deg, #e8f5e8 0%, #f0f8f0 100%);
                border: 1px solid #c8e6c9;
                border-radius: 8px;
                padding: 16px;
                margin: 16px 0;
                text-align: center;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            `;
        helpDiv.innerHTML = `
                <p style="margin: 0 0 8px 0; font-size: 14px; font-weight: 600; color: #1b5e20;">
                    ğŸŒ GitHub Pagesç‰ˆã§å…¬é–‹ä¸­
                </p>
                <p style="margin: 0 0 5px 0; font-size: 12px; color: #2e7d32;">
                    â€¢ ãƒ­ãƒ¼ã‚«ãƒ«ã‚µãƒ¼ãƒãƒ¼ä¸è¦ã§ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
                </p>
                <p style="margin: 0 0 5px 0; font-size: 12px; color: #2e7d32;">
                    â€¢ 115å·»ã™ã¹ã¦ã®ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆãŒåˆ©ç”¨å¯èƒ½
                </p>
                <p style="margin: 0; font-size: 12px; color: #2e7d32;">
                    â€¢ Universal Viewerã§é«˜è§£åƒåº¦è¡¨ç¤º
                </p>
            `;
        listContainer.appendChild(helpDiv);
      }

      // ã‚«ã‚¹ã‚¿ãƒ ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿
      function loadCustomManifest() {
        const url = document.getElementById("customUrl").value.trim();
        if (!url) {
          showStatus("URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", "error");
          return;
        }

        // ã‚«ã‚¹ã‚¿ãƒ URLã¯ãã®ã¾ã¾loadManifestã«æ¸¡ã™ï¼ˆloadManifestå†…ã§é©åˆ‡ãªfetchUrlã¨uvUrlToPassã‚’åˆ¤æ–­ï¼‰
        loadManifest(url);
      }

      // ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆä¸€è¦§ã‚’æ›´æ–°
      function refreshManifestList() {
        loadManifestList();
      }

      // === æ¥½æ›²æ¤œç´¢æ©Ÿèƒ½ ===
      let piecesData = null;

      // æ¥½æ›²ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
      async function loadPiecesData() {
        if (piecesData) return piecesData;

        // ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒã¨GitHub Pagesã®ä¸¡æ–¹ã«å¯¾å¿œ
        const isLocal =
          window.location.hostname === "localhost" ||
          window.location.hostname === "127.0.0.1";
        const localBaseUrl = `${window.location.protocol}//${window.location.host}`;

        let piecesIndexUrl = `${GITHUB_IIIF_BASE_URL}/100376839_pieces/pieces-index.json`;

        if (isLocal) {
          piecesIndexUrl = piecesIndexUrl.replace(
            GITHUB_IIIF_BASE_URL,
            localBaseUrl
          );
        }

        // console.log('Loading pieces data from:', piecesIndexUrl); // å‰Šé™¤

        try {
          const response = await fetch(piecesIndexUrl, {
            cache: "no-cache",
            headers: {
              "Cache-Control": "no-cache",
              Pragma: "no-cache",
            },
          });

          // console.log('Response status:', response.status); // å‰Šé™¤

          if (!response.ok) throw new Error("Failed to load pieces data");

          const data = await response.json();

          // piecesDataå†…ã®å„pieceã®@idã‚‚ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒç”¨ã«å¤‰æ›ï¼ˆloadManifestã«æ¸¡ã™ç”¨ï¼‰
          if (isLocal && data.pieces) {
            data.pieces.forEach((piece) => {
              if (
                piece["@id"] &&
                piece["@id"].startsWith(GITHUB_IIIF_BASE_URL)
              ) {
                piece["@id"] = piece["@id"].replace(
                  GITHUB_IIIF_BASE_URL,
                  localBaseUrl
                );
              }
            });
          }

          piecesData = data;

          // console.log('Pieces data loaded:', data); // å‰Šé™¤

          // ãƒ•ã‚£ãƒ«ã‚¿é¸æŠè‚¢ã‚’åˆæœŸåŒ–
          initializeFilters(data.statistics);

          return data;
        } catch (error) {
          console.error("Failed to load pieces data:", error);
          return null;
        }
      }

      // ãƒ•ã‚£ãƒ«ã‚¿é¸æŠè‚¢ã‚’åˆæœŸåŒ–
      function initializeFilters(statistics) {
        // console.log('Initializing filters with statistics:', statistics); // å‰Šé™¤

        const instrumentFilter = document.getElementById("instrumentFilter");
        const modeFilter = document.getElementById("modeFilter");
        const collectionFilter = document.getElementById("collectionFilter");

        if (!instrumentFilter || !modeFilter || !collectionFilter) {
          console.error("Filter elements not found!");
          return;
        }

        // æ¥½å™¨ãƒ•ã‚£ãƒ«ã‚¿
        instrumentFilter.innerHTML = '<option value="">æ¥½å™¨</option>';
        if (statistics.instruments) {
          // å­˜åœ¨ãƒã‚§ãƒƒã‚¯ã‚’æ˜ç¤ºçš„ã«è¡Œã†
          // console.log('Instruments data:', statistics.instruments); // å‰Šé™¤
          statistics.instruments.forEach((instrument) => {
            const option = document.createElement("option");
            option.value = instrument;
            option.textContent = instrument;
            instrumentFilter.appendChild(option);
          });
        }

        // èª¿å­ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆæŒ‡å®šã—ãŸé †åºã§è¡¨ç¤ºï¼‰
        modeFilter.innerHTML = '<option value="">èª¿å­</option>';
        const modeOrder = [
          "å£±è¶Šèª¿",
          "å¹³èª¿",
          "åŒèª¿",
          "é»„é˜èª¿",
          "ç›¤æ¸‰èª¿",
          "å¤ªé£Ÿèª¿",
        ];

        if (statistics.modes) {
          // å­˜åœ¨ãƒã‚§ãƒƒã‚¯ã‚’æ˜ç¤ºçš„ã«è¡Œã†
          // console.log('Modes data:', statistics.modes); // å‰Šé™¤
          // æŒ‡å®šã—ãŸé †åºã§èª¿ã‚’è¿½åŠ 
          modeOrder.forEach((mode) => {
            if (statistics.modes.includes(mode)) {
              const option = document.createElement("option");
              option.value = mode;
              option.textContent = mode;
              modeFilter.appendChild(option);
            }
          });

          // ä¸‡ãŒä¸€ã€æŒ‡å®šã—ãŸé †åºã«ãªã„èª¿ãŒã‚ã£ãŸå ´åˆã¯ãã®å¾Œã«è¿½åŠ 
          statistics.modes.forEach((mode) => {
            if (!modeOrder.includes(mode)) {
              const option = document.createElement("option");
              option.value = mode;
              option.textContent = mode;
              modeFilter.appendChild(option);
            } else if (mode === "å¹³èª¿") {
              // 'å¹³èª¿' ãŒå­˜åœ¨ã™ã‚‹å ´åˆã«ã®ã¿ 'æ±äº¬è—è¡“å¤§å­¦æ‰€è”µ' ã‚’è¿½åŠ 
              const option = document.createElement("option");
              option.value = "æ±äº¬è—è¡“å¤§å­¦æ‰€è”µ";
              option.textContent = "æ±äº¬è—è¡“å¤§å­¦æ‰€è”µ";
              collectionFilter.appendChild(option);
            }
          });
        }

        // è³‡æ–™ãƒ•ã‚£ãƒ«ã‚¿
        collectionFilter.innerHTML = '<option value="">è³‡æ–™</option>';
        // console.log('--- Checking Collection Filter Data ---'); // å‰Šé™¤
        // console.log('statistics.collections:', statistics.collections); // å‰Šé™¤

        if (statistics.collections) {
          // statistics.collectionsãŒtruthyã‹ã©ã†ã‹ç¢ºèª
          const collectionKeys = Object.keys(statistics.collections);
          // console.log('Collection keys found:', collectionKeys); // å‰Šé™¤
          if (collectionKeys.length > 0) {
            // console.log('Adding collection options...'); // å‰Šé™¤
            collectionKeys.forEach((collection) => {
              // console.log('Adding option for:', collection); // å‰Šé™¤
              const option = document.createElement("option");
              option.value = collection;
              option.textContent = collection;
              collectionFilter.appendChild(option);
            });
          } else {
            // console.log('No collection keys found or collections object is empty.'); // å‰Šé™¤
          }
        } else {
          // console.log('statistics.collections is null or undefined.'); // å‰Šé™¤
        }

        // console.log('Filters initialized successfully'); // å‰Šé™¤
      }

      // ========================================
      // æ—§å­—æ­£è¦åŒ–æ©Ÿèƒ½
      // ========================================

      /**
       * æ—§å­—æ­£è¦åŒ–ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’å–å¾—ã™ã‚‹é–¢æ•°
       * è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿ã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨­å®šã‚‚æä¾›
       */
      function getKanjiNormalizationMap() {
        // è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨
        if (typeof window.KANJI_NORMALIZATION_CONFIG !== "undefined") {
          return window.KANJI_NORMALIZATION_CONFIG;
        }

        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ãªã„å ´åˆã®æœ€å°é™ã®è¨­å®š
        return {
          æ¨‚: "æ¥½", // é‚„åŸæ¨‚ â†’ é‚„åŸæ¥½
          é¾: "ç«œ", // é¾ç¬› â†’ ç«œç¬›
        };
      }

      /**
       * æ—§å­—ã‚’æ–°å­—ã«æ­£è¦åŒ–ã™ã‚‹é–¢æ•°
       * @param {string} text - æ­£è¦åŒ–å¯¾è±¡ã®ãƒ†ã‚­ã‚¹ãƒˆ
       * @returns {string} æ­£è¦åŒ–ã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆ
       */
      function normalizeKanji(text) {
        let normalized = text;
        const kanjiMap = getKanjiNormalizationMap();

        // å„æ—§å­—-æ–°å­—ãƒšã‚¢ã«å¯¾ã—ã¦ç½®æ›ã‚’å®Ÿè¡Œ
        for (const [oldKanji, newKanji] of Object.entries(kanjiMap)) {
          normalized = normalized.replace(new RegExp(oldKanji, "g"), newKanji);
        }

        return normalized;
      }

      /**
       * æ—§å­—æ­£è¦åŒ–ãƒãƒƒãƒ”ãƒ³ã‚°ã«æ–°ã—ã„ãƒšã‚¢ã‚’å‹•çš„ã«è¿½åŠ ã™ã‚‹é–¢æ•°
       * @param {string} oldKanji - æ—§å­—
       * @param {string} newKanji - æ–°å­—
       */
      function addKanjiNormalization(oldKanji, newKanji) {
        if (typeof window.KANJI_NORMALIZATION_CONFIG !== "undefined") {
          window.KANJI_NORMALIZATION_CONFIG[oldKanji] = newKanji;
          console.log(`âœ… æ—§å­—æ­£è¦åŒ–ãƒšã‚¢è¿½åŠ : ${oldKanji} â†’ ${newKanji}`);
          console.log(
            "ğŸ’¡ å¤‰æ›´ã‚’æ°¸ç¶šåŒ–ã™ã‚‹ã«ã¯ kanji-normalization-config.js ã‚’ç·¨é›†ã—ã¦ãã ã•ã„"
          );
        } else {
          console.warn("âš ï¸ è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“");
        }
      }

      /**
       * ç¾åœ¨ã®æ—§å­—æ­£è¦åŒ–ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
       */
      function showKanjiNormalizationMap() {
        const kanjiMap = getKanjiNormalizationMap();
        console.log("=".repeat(50));
        console.log("ğŸ”¤ ç¾åœ¨ã®æ—§å­—æ­£è¦åŒ–ãƒãƒƒãƒ”ãƒ³ã‚°:");
        console.log("=".repeat(50));

        let count = 0;
        for (const [oldKanji, newKanji] of Object.entries(kanjiMap)) {
          console.log(`  ${oldKanji} â†’ ${newKanji}`);
          count++;
        }

        console.log("=".repeat(50));
        console.log(`ğŸ“Š åˆè¨ˆ: ${count} ãƒšã‚¢`);
        console.log("=".repeat(50));
        console.log(
          'ğŸ’¡ æ–°ã—ã„ãƒšã‚¢ã‚’è¿½åŠ : addKanjiNormalization("æ—§å­—", "æ–°å­—")'
        );
      }

      // æ¥½æ›²æ¤œç´¢æ©Ÿèƒ½
      async function searchPieces() {
        const data = await loadPiecesData();
        if (!data) return;

        const searchTerm = document
          .getElementById("searchInput")
          .value.toLowerCase();
        const instrumentFilter =
          document.getElementById("instrumentFilter").value;
        const modeFilter = document.getElementById("modeFilter").value;
        const collectionFilter =
          document.getElementById("collectionFilter").value;

        // 2-1: ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãŒæœªé¸æŠã§ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒç©ºã®å ´åˆã€æ¤œç´¢çµæœã‚’éè¡¨ç¤º
        if (
          !searchTerm &&
          !instrumentFilter &&
          !modeFilter &&
          !collectionFilter
        ) {
          hideSearchResults();
          return;
        }

        // æ¤œç´¢èªã‚’æ­£è¦åŒ–ï¼ˆæ—§å­—â†’æ–°å­—å¤‰æ›ï¼‰
        const normalizedSearchTerm = normalizeKanji(searchTerm);

        // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
        let filteredPieces = data.pieces.filter((piece) => {
          // æ¥½æ›²ã‚¿ã‚¤ãƒˆãƒ«ã®ã¿ã‚’æ­£è¦åŒ–ã—ã¦æ¯”è¼ƒ
          const normalizedPieceName = normalizeKanji(
            piece.metadata.piece_name.toLowerCase()
          );

          const matchesSearch =
            !searchTerm ||
            normalizedPieceName.includes(normalizedSearchTerm) ||
            // å…ƒã®æ¤œç´¢èªã§ã‚‚æ¤œç´¢ï¼ˆæ—§å­—ã§ã®æ¤œç´¢ã‚‚å¯èƒ½ï¼‰
            piece.metadata.piece_name.toLowerCase().includes(searchTerm);

          const matchesInstrument =
            !instrumentFilter || piece.metadata.instrument === instrumentFilter;

          const matchesMode = !modeFilter || piece.metadata.mode === modeFilter;

          const matchesCollection =
            !collectionFilter || piece.metadata.collection === collectionFilter;

          return (
            matchesSearch &&
            matchesInstrument &&
            matchesMode &&
            matchesCollection
          );
        });

        // çµæœã‚’è¡¨ç¤º
        displaySearchResults(filteredPieces, data.pieces.length);
      }

      // æ¤œç´¢çµæœã‚’è¡¨ç¤º
      function displaySearchResults(pieces, totalCount) {
        const resultsContainer = document.getElementById("searchResults");
        const statsContainer = document.getElementById("searchStats");

        // æ¤œç´¢çµæœã‚’è¡¨ç¤º
        resultsContainer.style.display = "block";

        // çµ±è¨ˆè¡¨ç¤º
        statsContainer.textContent = `${pieces.length} / ${totalCount} æ›²`;

        // ãƒšãƒ¼ã‚¸é †ã§ã‚½ãƒ¼ãƒˆã—ã¦ã‹ã‚‰çµæœã‚’ä¿å­˜
        const sortedPieces = [...pieces].sort((a, b) => {
          // ãƒšãƒ¼ã‚¸ç¯„å›²ã«ã‚ˆã‚‹è©³ç´°ã‚½ãƒ¼ãƒˆï¼šé–‹å§‹ãƒšãƒ¼ã‚¸ -> çµ‚äº†ãƒšãƒ¼ã‚¸ã®é †
          const aRange = a.metadata.page_range.split("-");
          const bRange = b.metadata.page_range.split("-");
          const aStart = parseInt(aRange[0]);
          const bStart = parseInt(bRange[0]);
          const aEnd = parseInt(aRange[1] || aRange[0]); // çµ‚äº†ãƒšãƒ¼ã‚¸ãŒãªã„å ´åˆã¯é–‹å§‹ãƒšãƒ¼ã‚¸ã¨åŒã˜
          const bEnd = parseInt(bRange[1] || bRange[0]);

          // ã¾ãšé–‹å§‹ãƒšãƒ¼ã‚¸ã§æ¯”è¼ƒ
          if (aStart !== bStart) {
            return aStart - bStart;
          }
          // é–‹å§‹ãƒšãƒ¼ã‚¸ãŒåŒã˜å ´åˆã¯çµ‚äº†ãƒšãƒ¼ã‚¸ã§æ¯”è¼ƒ
          return aEnd - bEnd;
        });

        currentSortedResults = sortedPieces;

        // ã‚½ãƒ¼ãƒˆé¸æŠã‚’ãƒšãƒ¼ã‚¸é †ã«ãƒªã‚»ãƒƒãƒˆ
        document.getElementById("sortBy").value = "page_range";

        // æ¥½æ›²ãƒªã‚¹ãƒˆè¡¨ç¤º
        displayPiecesList(sortedPieces);
      }

      // æ¤œç´¢çµæœã‚’éè¡¨ç¤ºã«ã™ã‚‹
      function hideSearchResults() {
        const resultsContainer = document.getElementById("searchResults");
        const statsContainer = document.getElementById("searchStats");

        resultsContainer.style.display = "none";
        statsContainer.textContent = "";

        // ç¾åœ¨ã®æ¤œç´¢çµæœã‚’ã‚¯ãƒªã‚¢
        currentSortedResults = [];
      }

      // 2-2: æ¤œç´¢çµæœã‚’ã‚¯ãƒªã‚¢ã™ã‚‹é–¢æ•°
      function clearSearchResults() {
        // ã™ã¹ã¦ã®æ¤œç´¢æ¡ä»¶ã‚’ã‚¯ãƒªã‚¢
        document.getElementById("searchInput").value = "";
        document.getElementById("instrumentFilter").value = "";
        document.getElementById("modeFilter").value = "";
        document.getElementById("collectionFilter").value = "";

        // æ¤œç´¢çµæœã‚’éè¡¨ç¤º
        hideSearchResults();

        // æ¤œç´¢ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ã‚‚æ›´æ–°
        updateSearchClearButton();

        console.log("ğŸ” æ¤œç´¢çµæœã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ");
      }

      // æ¤œç´¢ã‚’ã‚¯ãƒªã‚¢
      // æ¤œç´¢ã‚’ã‚¯ãƒªã‚¢ï¼ˆæ—¢å­˜ã®æ©Ÿèƒ½ã€ä¸»ã«Ã—ãƒœã‚¿ãƒ³ç”¨ï¼‰
      function clearSearch() {
        document.getElementById("searchInput").value = "";
        document.getElementById("instrumentFilter").value = "";
        document.getElementById("modeFilter").value = "";
        document.getElementById("collectionFilter").value = "";
        searchPieces(); // ã“ã‚Œã«ã‚ˆã‚Šã€ã™ã¹ã¦ç©ºã®å ´åˆã¯æ¤œç´¢çµæœãŒéè¡¨ç¤ºã«ãªã‚‹
        updateSearchClearButton();
      }

      // æ¤œç´¢ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
      function updateSearchClearButton() {
        const searchInput = document.getElementById("searchInput");
        const clearButton = document.getElementById("searchClear");

        if (searchInput.value) {
          clearButton.classList.add("visible");
        } else {
          clearButton.classList.remove("visible");
        }
      }

      // å…¨æ¥½æ›²ã‚’è¡¨ç¤º
      async function showAllPieces() {
        const data = await loadPiecesData();
        if (!data) return;

        // æ¤œç´¢æ¡ä»¶ã‚’ã‚¯ãƒªã‚¢
        document.getElementById("searchInput").value = "";
        document.getElementById("instrumentFilter").value = "";
        document.getElementById("modeFilter").value = "";
        document.getElementById("collectionFilter").value = "";
        updateSearchClearButton();

        // å…¨æ¥½æ›²ã‚’è¡¨ç¤ºï¼ˆæ¤œç´¢çµæœã¨ã—ã¦è¡¨ç¤ºï¼‰
        displaySearchResults(data.pieces, data.pieces.length);
      }

      // çµ±è¨ˆæƒ…å ±ã‚’è¡¨ç¤º
      async function showStatistics() {
        const data = await loadPiecesData();
        if (!data) return;

        const stats = data.statistics;
        const instrumentStats = {};
        const modeStats = {};

        // æ¥½å™¨åˆ¥ã€èª¿åˆ¥ã®çµ±è¨ˆã‚’è¨ˆç®—
        data.pieces.forEach((piece) => {
          const instrument = piece.metadata.instrument;
          const mode = piece.metadata.mode;

          instrumentStats[instrument] = (instrumentStats[instrument] || 0) + 1;
          modeStats[mode] = (modeStats[mode] || 0) + 1;
        });

        // çµ±è¨ˆæƒ…å ±ã‚’HTMLã§è¡¨ç¤º
        const statsHtml = `
                <div class="statistics-panel">
                    <h4>ğŸ“Š æ¥½æ›²çµ±è¨ˆ</h4>
                    <div class="stat-group">
                        <h5>æ¥½å™¨åˆ¥ (${stats.instruments.length}ç¨®é¡)</h5>
                        ${stats.instruments
                          .map(
                            (inst) =>
                              `<div class="stat-item">
                                <span class="piece-badge instrument">${inst}</span>
                                <span>${instrumentStats[inst]}æ›²</span>
                            </div>`
                          )
                          .join("")}
                    </div>
                    <div class="stat-group">
                        <h5>èª¿åˆ¥ (${stats.modes.length}ç¨®é¡)</h5>
                        ${stats.modes
                          .map(
                            (mode) =>
                              `<div class="stat-item">
                                <span class="piece-badge mode">${mode}</span>
                                <span>${modeStats[mode]}æ›²</span>
                            </div>`
                          )
                          .join("")}
                    </div>
                    <div class="stat-total">
                        <strong>ç·æ¥½æ›²æ•°: ${stats.total_pieces}æ›²</strong>
                    </div>
                </div>
            `;

        const resultsContainer = document.getElementById("searchResults");
        const piecesListContainer = document.getElementById("piecesList");
        const statsContainer = document.getElementById("searchStats");

        resultsContainer.style.display = "block";
        statsContainer.textContent = "çµ±è¨ˆæƒ…å ±";
        piecesListContainer.innerHTML = statsHtml;
      }

      // æ¤œç´¢çµæœã‚’ã‚½ãƒ¼ãƒˆ
      let currentSortedResults = [];

      function sortSearchResults() {
        const sortBy = document.getElementById("sortBy").value;

        const sorted = [...currentSortedResults].sort((a, b) => {
          let aVal, bVal;

          switch (sortBy) {
            case "piece_name":
              aVal = a.metadata.piece_name;
              bVal = b.metadata.piece_name;
              break;
            case "instrument":
              aVal = a.metadata.instrument;
              bVal = b.metadata.instrument;
              break;
            case "mode":
              aVal = a.metadata.mode;
              bVal = b.metadata.mode;
              break;
            case "collection":
              aVal = a.metadata.collection || "";
              bVal = b.metadata.collection || "";
              break;
            case "page_range":
              // ãƒšãƒ¼ã‚¸ç¯„å›²ã«ã‚ˆã‚‹è©³ç´°ã‚½ãƒ¼ãƒˆï¼šé–‹å§‹ãƒšãƒ¼ã‚¸ -> çµ‚äº†ãƒšãƒ¼ã‚¸ã®é †
              const aRange = a.metadata.page_range.split("-");
              const bRange = b.metadata.page_range.split("-");
              const aStart = parseInt(aRange[0]);
              const bStart = parseInt(bRange[0]);
              const aEnd = parseInt(aRange[1] || aRange[0]); // çµ‚äº†ãƒšãƒ¼ã‚¸ãŒãªã„å ´åˆã¯é–‹å§‹ãƒšãƒ¼ã‚¸ã¨åŒã˜
              const bEnd = parseInt(bRange[1] || bRange[0]);

              // ã¾ãšé–‹å§‹ãƒšãƒ¼ã‚¸ã§æ¯”è¼ƒ
              if (aStart !== bStart) {
                return aStart - bStart;
              }
              // é–‹å§‹ãƒšãƒ¼ã‚¸ãŒåŒã˜å ´åˆã¯çµ‚äº†ãƒšãƒ¼ã‚¸ã§æ¯”è¼ƒ
              return aEnd - bEnd;
            default:
              return 0;
          }

          return aVal.localeCompare(bVal);
        });

        currentSortedResults = sorted;
        displayPiecesList(sorted);
      }

      // æ¥½æ›²ãƒªã‚¹ãƒˆã®è¡¨ç¤ºï¼ˆã‚½ãƒ¼ãƒˆæ©Ÿèƒ½ä»˜ãï¼‰
      function displayPiecesList(pieces) {
        const piecesListContainer = document.getElementById("piecesList");

        // ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³åã‚’çŸ­ç¸®è¡¨ç¤ºã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        function getShortCollectionName(collection) {
          if (!collection) return "ä¸æ˜";
          if (collection === "æ±äº¬è—è¡“å¤§å­¦æ‰€è”µ") return "è—å¤§";
          return collection;
        }

        if (pieces.length === 0) {
          piecesListContainer.innerHTML =
            '<div class="piece-item">æ¤œç´¢æ¡ä»¶ã«ä¸€è‡´ã™ã‚‹æ¥½æ›²ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>';
        } else {
          piecesListContainer.innerHTML = pieces
            .map(
              (piece) => `
                    <div class="piece-item" onclick="loadManifest('${
                      piece["@id"]
                    }')">
                        <div class="piece-title">${
                          piece.metadata.piece_name
                        }</div>
                        <div class="piece-meta">
                            <span class="piece-badge instrument">${
                              piece.metadata.instrument
                            }</span>
                            <span class="piece-badge mode">${
                              piece.metadata.mode
                            }</span>
                            <span class="piece-badge collection">${getShortCollectionName(
                              piece.metadata.collection
                            )}</span>
                            <span>ãƒšãƒ¼ã‚¸ ${piece.metadata.page_range}</span>
                        </div>
                    </div>
                `
            )
            .join("");
        }
      }

      // åˆæœŸåŒ–æ™‚ã«æ¥½æ›²ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
      document.addEventListener("DOMContentLoaded", function () {
        loadPiecesData();

        // æ¤œç´¢å…¥åŠ›ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
        const searchInput = document.getElementById("searchInput");
        searchInput.addEventListener("input", function () {
          searchPieces();
          updateSearchClearButton();
        });

        // åˆæœŸçŠ¶æ…‹ã§ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
        updateSearchClearButton();
      });

      // ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆä¸€è¦§ã‚’æ›´æ–°
      function refreshManifestList() {
        loadManifestList();
      }

      // åˆæœŸåŒ–
      document.addEventListener("DOMContentLoaded", function () {
        // console.log('IIIF Viewer initializing...'); // å‰Šé™¤
        // console.log('Current protocol:', window.location.protocol); // å‰Šé™¤
        // console.log('Current origin:', window.location.origin); // å‰Šé™¤

        // å…¨ç”»é¢è¡¨ç¤ºã‚µãƒãƒ¼ãƒˆã‚’æœ‰åŠ¹åŒ–
        enableFullscreenSupport();

        // ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã®å•é¡Œã‚’æ—©æœŸæ¤œå‡º
        const hasProtocolIssue = detectProtocolIssue();

        // åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        const iframe = document.getElementById("viewerIframe"); // IDã‚’æ±ç”¨çš„ãªã‚‚ã®ã«å¤‰æ›´
        iframe.src = "about:blank"; // Clear initial content
        iframe.onload = () => {
          // Ensure content is loaded before displaying message
          iframe.contentWindow.document.open();
          iframe.contentWindow.document.write(`
                    <!DOCTYPE html>
                    <html lang="ja">
                    <head>
                        <meta charset="UTF-8">
                        <meta name="viewport" content="width=device-width, initial-scale=1.0">
                        <title>é›…æ¥½è­œ IIIF ãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼</title>
                    </head>
                    <body style="margin:0;padding:0;font-family:Arial,sans-serif;">
                        <div style="display:flex;align-items:center;justify-content:center;height:100vh;text-align:center;color:#666;background:#f9f9f9;">
                            <div style="padding:40px;max-width:600px;">
                                <h2 style="margin:0 0 20px 0;color:#333;">ğŸ¼ é›…æ¥½è­œ IIIF ãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼</h2>
                                <p style="margin:0 0 15px 0;font-size:16px;line-height:1.6;">å·¦å´ã®ãƒªã‚¹ãƒˆã‹ã‚‰ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„</p>
                                <div style="background:#e3f2fd;padding:20px;border-radius:8px;margin:20px 0;border-left:4px solid #2196f3;">
                                    <p style="margin:0 0 10px 0;font-size:14px;color:#1565c0;font-weight:bold;">ğŸ“š åˆ©ç”¨å¯èƒ½ãªã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼š</p>
                                    <p style="margin:0 0 8px 0;font-size:13px;color:#333;">â€¢ å®®å†…åºæ›¸é™µéƒ¨æ‰€è”µç‰ˆ</p>
                                    <p style="margin:0;font-size:13px;color:#333;">â€¢ æ±äº¬èŠ¸è¡“å¤§å­¦æ‰€è”µç‰ˆ</p>
                                </div>
                                ${
                                  hasProtocolIssue
                                    ? `
                                <div style="background:#ffebee;padding:15px;border-radius:6px;margin:20px 0;border-left:4px solid #f44336;">
                                    <p style="margin:0 0 10px 0;font-size:13px;color:#c62828;font-weight:bold;">
                                        âš ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ¶é™ã«ã¤ã„ã¦
                                    </p>
                                    <p style="margin:0 0 8px 0;font-size:12px;color:#c62828;">
                                        ç¾åœ¨HTTPSãƒšãƒ¼ã‚¸ã‹ã‚‰HTTPãƒªã‚½ãƒ¼ã‚¹ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒåˆ¶é™ã•ã‚Œã¦ã„ã¾ã™ã€‚
                                    </p>
                                    <p style="margin:0;font-size:12px;color:#c62828;">
                                        ãƒ­ãƒ¼ã‚«ãƒ«ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‚’è¡¨ç¤ºã™ã‚‹ã«ã¯ã€HTTPã§ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„ã€‚
                                    </p>
                                </div>
                                `
                                    : ""
                                }
                                <p style="margin:20px 0 0 0;font-size:14px;color:#888;">
                                    ã¾ãŸã¯ã€ã‚«ã‚¹ã‚¿ãƒ URLã‚’å…¥åŠ›ã—ã¦ä»»æ„ã®IIIFãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‚’è¡¨ç¤ºã§ãã¾ã™
                                </p>
                                <div style="margin-top:30px;padding:15px;background:#fff3cd;border-radius:6px;border-left:4px solid #ffc107;">
                                    <p style="margin:0;font-size:13px;color:#856404;">
                                        ğŸ’¡ ãƒ’ãƒ³ãƒˆ: ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‚’é¸æŠã™ã‚‹ã¨ã€é«˜è§£åƒåº¦ã®é›…æ¥½è­œç”»åƒã‚’ã‚ºãƒ¼ãƒ ãƒ»ãƒ‘ãƒ³æ“ä½œã§è©³ç´°ã«é–²è¦§ã§ãã¾ã™
                                    </p>
                                </div>
                            </div>
                        </div>
                    </body>
                    </html>
                `);
          iframe.contentWindow.document.close();
        };

        // ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
        loadManifestList();

        showStatus(
          "ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‚’é¸æŠã—ã¦é›…æ¥½è­œã®é–²è¦§ã‚’é–‹å§‹ã—ã¦ãã ã•ã„",
          "info"
        );
      });

      // ãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼åˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
      document.getElementById("uvViewerBtn").addEventListener("click", () => {
        activeViewerType = "uv";
        if (currentManifestUrl) {
          loadManifest(currentManifestUrl);
        }
      });

      document
        .getElementById("miradorViewerBtn")
        .addEventListener("click", () => {
          activeViewerType = "mirador";
          if (currentManifestUrl) {
            loadManifest(currentManifestUrl);
          }
        });

      // ã‚¨ãƒ³ã‚¿ãƒ¼ã‚­ãƒ¼ã§ã‚«ã‚¹ã‚¿ãƒ URLèª­ã¿è¾¼ã¿
      document
        .getElementById("customUrl")
        .addEventListener("keypress", function (event) {
          if (event.key === "Enter") {
            loadCustomManifest();
          }
        });
    </script>
  </body>
</html>
