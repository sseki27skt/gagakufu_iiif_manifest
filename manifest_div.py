import json
import copy

def extract_volume(manifest, start_idx, end_idx, volume_number,volume_title):
    """
    指定された巻の範囲（1-based index）で新しいマニフェストを作成。
    """
    new_manifest = copy.deepcopy(manifest)
    
    original_sequence = manifest["sequences"][0]
    # 1-based index → 0-based index に変換
    new_canvases = original_sequence["canvases"][start_idx - 1:end_idx]

    new_manifest["sequences"][0]["canvases"] = new_canvases
    new_manifest["@id"] += f"/volume_{volume_number}"
    new_manifest["label"] += f"（{volume_title}）"
    #     new_manifest["label"] += f"（巻：{volume_number}）"


    return new_manifest

# マニフェストを読み込み
with open("manifest.json", encoding="utf-8") as f:
    manifest = json.load(f)

volume_titles = [
"表紙",
"雅楽譜総目録",
"唱物之部 神楽歌譜",
"唱物之部 東遊大和歌譜",
"唱物之部 催馬楽歌譜",
"唱物之部 朗詠譜",
"和琴之部 神楽歌譜",
"和琴之部 東歌大和歌譜",
"和琴之部 催馬楽譜",
"琵琶之譜 大曲譜",
"琵琶之譜 中小曲譜 上",
"琵琶之譜 中小曲譜 下",
"琵琶之譜 高麗大曲譜",
"琵琶之譜 高麗中小曲譜",
"琵琶之譜 催馬楽譜",
"琵琶之譜 延只拍子曲譜",
"筝之部 大曲譜",
"筝之部 中小曲譜 上",
"筝之部 中小曲譜 下",
"筝之部 高麗大曲譜",
"筝之部 高麗中小曲譜",
"筝之部 催馬楽譜",
"筝之部 延只拍子曲譜",
"鳳笙之部 大曲譜",
"鳳笙之部 中小曲譜 壱越調",
"鳳笙之部 中小曲譜 太食調",
"鳳笙之部 中小曲譜 双調",
"鳳笙之部 中小曲譜 平調",
"鳳笙之部 中小曲譜 黄鐘調",
"鳳笙之部 中小曲譜 盤渉調",
"鳳笙之部 催馬楽譜",
"鳳笙之部 延只拍子曲譜",
"鳳笙之部 舞楽用曲譜",
"篳篥之部 神楽譜",
"篳篥之部 東歌大和歌譜",
"篳篥之部 大曲譜",
"篳篥之部 中小曲譜 壱越調",
"篳篥之部 中小曲譜 太食調",
"篳篥之部 中小曲譜 双調",
"篳篥之部 中小曲譜 平調",
"篳篥之部 中小曲譜 黄鐘調",
"篳篥之部 中小曲譜 盤渉調",
"篳篥之部 高麗大曲譜",
"篳篥之部 高麗中小曲譜",
"篳篥之部 催馬楽譜",
"篳篥之部 延只拍子曲譜",
"篳篥之部 舞楽用曲譜",
"笛之部 神楽譜",
"笛之部 東歌大和歌譜",
"笛之部 大曲譜",
"笛之部 中小曲譜 壱越調",
"笛之部 中小曲譜 太食調",
"笛之部 中小曲譜 双調",
"笛之部 中小曲譜 平調",
"笛之部 中小曲譜 黄鐘調",
"笛之部 中小曲譜 盤渉調",
"笛之部 高麗大曲譜",
"笛之部 高麗中小曲譜",
"笛之部 催馬楽譜",
"笛之部 延只拍子曲譜",
"笛之部 舞楽用曲譜",
"皷類之譜 鞨皷太皷鉦皷大曲譜",
"皷類之譜 鞨皷一皷三皷中小曲譜",
"皷類之譜 太皷中小曲譜",
"皷類之譜 鉦皷中小曲譜",
"舞之部 人長東歌大和歌舞譜",
"舞之部 左舞大曲譜",
"舞之部 左舞中小曲譜 上",
"舞之部 左舞中小曲譜 下",
"舞之部 右舞大曲譜",
"舞之部 右舞中小曲譜 上",
"舞之部 右舞中小曲譜 下",
"歌笛篳篥和琴秘曲譜"
# "表紙",
# "楽譜総目録",
# "鳳笙中小曲譜上",
# "鳳笙中小曲譜下",
# "舞楽用鳳笙譜",
# "鳳笙大曲譜",
# "催馬楽笙譜",
# "篳篥中小曲譜上",
# "篳篥中小曲譜下",
# "高麗篳篥譜",
# "舞楽用篳篥譜",
# "篳篥大曲譜",
# "神楽篳篥譜",
# "催馬楽篳篥譜",
# "龍笛中小曲譜上",
# "龍笛中小曲譜下",
# "高麗笛譜",
# "舞楽要笛譜",
# "龍笛大曲",
# "神楽笛譜",
# "催馬楽笛譜",
# "琵琶譜上",
# "琵琶譜下",
# "高麗琵琶譜",
# "大曲琵琶譜",
# "催馬楽琵琶譜",
# "筝譜上",
# "筝譜下",
# "高麗筝譜",
# "大曲筝譜",
# "催馬楽筝譜",
# "鞨鼓壹鼓三鼓譜",
# "太鼓譜",
# "鉦鼓譜",
# "大曲三鼓譜",
# "神楽歌譜",
# "東遊大和歌譜",
# "催馬楽歌譜",
# "朗詠譜",
# "神楽和琴譜",
# "東遊大和歌和琴譜",
# "催馬楽和琴譜"
]

# 各巻の終了インデックス（1-based）だけを指定
end_indexes = [
    1, 11, 133, 214, 257, 312, 339, 357, 382, 432, 546, 600, 615, 654, 672, 681, 727, 830, 865, 879, 916, 935, 944, 1012, 1059, 1097, 1139, 1192, 1230, 1281, 1302, 1312, 1345, 1418, 1464, 1533, 1572, 1613, 1656, 1705, 1739, 1786, 1806, 1857, 1878, 1891, 1925, 1995, 2040, 2112, 2158, 2203, 2248, 2300, 2353, 2391, 2413, 2468, 2489, 2502, 2551, 2579, 2599, 2628, 2667, 2707, 2814, 2925, 3093, 3112, 3190, 3227, 3246
    # 1, 66, 159, 209, 230, 267, 282, 368, 420, 454,
    # 475, 523, 587, 602, 699, 752, 788, 815, 865, 926,
    # 941, 1025, 1073, 1100, 1135, 1149, 1218, 1262, 1288, 1321,
    # 1336, 1361, 1381, 1395, 1412, 1510, 1553, 1579, 1611, 1630,
    # 1642, 1660
]

base_url = "https://sseki27skt.github.io/gagakufu_iiif_manifest/100270332"


# 開始インデックスを逐次的に算出してマニフェストを保存
previous_end = 0

for i, end_canvas in enumerate(end_indexes, start=0):
    start_canvas = previous_end + 1
    volume_title = volume_titles[i] if i < len(volume_titles) else f"巻第{i}"

    # マニフェストを抽出
    volume_manifest = extract_volume(manifest, start_canvas, end_canvas, i, volume_title)

    # @id を GitHub 上の公開URLに置き換え
    out_filename = f"volume{i}_manifest.json"
    volume_manifest["@id"] = f"{base_url}/{out_filename}"

    # 保存
    with open(out_filename, "w", encoding="utf-8") as f:
        json.dump(volume_manifest, f, ensure_ascii=False, indent=2)

    print(f"巻{i}（{start_canvas}〜{end_canvas}）→ {out_filename} に保存しました。")
    previous_end = end_canvas




